#                    race_eth_fct_cpsd +
#                    educ_fct +
#                    tage +
#                    age_sq +
#                    sex_fct +
#                    immig_fct +
#                    married +
#                    parent_std +
#                    calyear +
#                    mode_industry , data = person_year,
#                    index = c("ssuid_spanel_pnum", "calyear"),
#                    model = "random")
unemp_m3_plm <- update(unemp_m2_plm, . ~. + industry_numeric)
unemp_m4_plm <- update(unemp_m3_plm, . ~ . + industry_experience)
unemp_m5_plm <- update(unemp_m4_plm, . ~ . + industry_experience*unemp_f12_6)
unemp_m6_plm <- update(unemp_m4_plm, . ~ . + ln_thnetworth)
unemp_m7_plm <- update(unemp_m2_plm, . ~ . + industry_experience)
unemp_m8_plm <- update(unemp_m2_plm, . ~ . + mode_industry)
unemp_m9_plm <- update(unemp_m8_plm, . ~ . + industry_experience)
unemp_m10_plm <- update(unemp_m9_plm, . ~. + ln_thnetworth)
mapping <- c(
# Main Variables of Interest
"unemp_f12_6Unemployed" = "Unemployed 6+",
"unemp_f12_3Unemployed" = "Unemployed 3+",
"y1_status_v2Self-Employed" = "Self-Employed",
"y1_status_v2Unemployed" = "Unemployed",
"race_eth_fct_cpsdNon_white" = "Non-White",
"industry_experience" = "Prior Industry Experience: Yes",
"unemp_f12_6Unemployed:industry_experience" = "Unemployed*Prior Industry Experience",
"unemp_f12_3Unemployed:industry_experience" = "Unemployed*Prior Industry Experience",
"y1_status_v2Self-Employed:industry_experience" = "Self-Employed*Prior Industry Experience",
"y1_status_v2Unemployed:industry_experience" = "Unemployed*Prior Industry Experience",
# Demographic Variables
"sex_fctFemale" = "Female",
"tage" = "Age",
"age_sq" = "Age sq",
"immig_fctImmigrant" = "Immigrant",
"marriedMarried" = "Married",
"parent_stdParent" = "Parent",
# Education
"educ_fctSome College or Assoc" = "Some College or Assoc",
"educ_fct4-year Degree or More" = "4-Year Degree +",
# Year Effects
"calyear2015" = "2015",
"calyear2016" = "2016",
"calyear2018" = "2018",
"calyear2019" = "2019",
"calyear2020" = "2020",
"calyear2021" = "2021",
"calyear2022" = "2022",
"calyear2023" = "2023",
# Industry Effects
"industry_numeric" = "Industry" ,
"mode_industryConstruction" = "Construction",
"mode_industryOther Services, Except Public Administration" = "Other Services",
"mode_industryEducational Services, and Health Care and Social Assistance" = "Educ. & Health",
"mode_industryFinance and Insurance, and Real Estate, and Rental and Leasing" = "Finance & Real Estate",
"mode_industryRetail Trade" = "Retail Trade",
"mode_industryArts, Entertainment, and Recreation, and Accommodation and Food Services" = "Arts & Food Services",
"mode_industryForestry, Farming, Fishing, Hunting, & Mining" = "Forestry, Farming, & Mining",
"mode_industryTransportation, Warehousing & Utilities" = "Transport. & Utilities",
"mode_industryManufacturing" = "Manufacturing",
"mode_industryWholesale Trade" = "Wholesale Trade",
"mode_industryInformation" = "Information",
"mode_industryPublic Administration" = "Public Administration",
"ln_thnetworth" = "Household Net Worth (log)",
"(Intercept)" = "(Intercept)",
"SD (Intercept ssuid_spanel_pnum)" = "SD (Intercept Individual ID)",
"SD (Intercept shhadid)" = "SD (Intercept Household)",
"SD (Observations)" = "SD (Observations)"
)
# collect_coef_names <- function(models) {
#   sort(unique(unlist(lapply(models, function(m){
#     ch <- tryCatch(names(coef(m)), error = function(e) NULL)
#     if (is.null(ch)) {
#       td <- tryCatch(tidy(m)$term, error = function(e) NULL)
#       ch <- if (!is.null(td)) as.character(td) else character(0)
#     }
#     ch
#   }))))
# }
#
# collect_coef_names(list(unemp_m3_hlm))
library(broom)
# Helper to build coef_map with custom labels & order
build_coef_map_ordered <- function(models, custom, order) {
# Get all coefficient names across models
all_coefs <- unique(unlist(lapply(models, function(m) {
ch <- tryCatch(names(coef(m)), error = function(e) NULL)
if (is.null(ch)) {
td <- tryCatch(tidy(m)$term, error = function(e) NULL)
ch <- if (!is.null(td)) as.character(td) else character(0)
}
ch
})))
# Default map: each coef name maps to itself
map <- setNames(all_coefs, all_coefs)
# Overwrite custom names
map[names(custom)] <- custom
# Reorder: put variables listed in 'order' first, then the rest
ordered_names <- c(order, setdiff(names(map), order))
map[ordered_names]
}
desired_order <- c(
# Main Variables of Interest
"unemp_f12_6Unemployed",
"unemp_f12_3Unemployed",
"y1_status_v2Self-Employed",
"y1_status_v2Unemployed",
"race_eth_fct_cpsdNon_white" ,
"industry_experience",
"unemp_f12_6Unemployed:industry_experience",
"unemp_f12_3Unemployed:industry_experience",
"y1_status_v2Self-Employed:industry_experience",
"y1_status_v2Unemployed:industry_experience",
# Demographic Variables
"sex_fctFemale",
"tage" ,
"age_sq",
"immig_fctImmigrant",
"marriedMarried",
"parent_stdParent",
# Education
"educ_fctSome College or Assoc",
"educ_fct4-year Degree or More",
"ln_thnetworth",
# Industry Effects
"industry_numeric",
"mode_industryConstruction",
"mode_industryOther Services, Except Public Administration",
"mode_industryEducational Services, and Health Care and Social Assistance",
"mode_industryFinance and Insurance, and Real Estate, and Rental and Leasing",
"mode_industryRetail Trade",
"mode_industryArts, Entertainment, and Recreation, and Accommodation and Food Services",
"mode_industryForestry, Farming, Fishing, Hunting, & Mining",
"mode_industryTransportation, Warehousing & Utilities",
"mode_industryManufacturing",
"mode_industryWholesale Trade",
"mode_industryInformation",
"mode_industryPublic Administration",
# Year Effects
"calyear2015",
"calyear2016",
"calyear2018",
"calyear2019",
"calyear2020",
"calyear2021",
"calyear2022",
"calyear2023",
"SD (Intercept ssuid_spanel_pnum)" ,
"SD (Intercept shhadid)",
"SD (Observations)"
)
coef_map <- build_coef_map_ordered(list(unemp_m1_plm,
unemp_m2_plm,
unemp_m3_plm,
unemp_m4_plm,
unemp_m5_plm,
unemp_m6_plm,
unemp_m7_plm,
unemp_m8_plm,
unemp_m9_plm,
unemp_m10_plm), mapping, desired_order)
rows_to_add <- tribble(
~term, ~m1, ~m2, ~m3, ~m4, ~m5, ~m6, ~m7, ~m8, ~m9, ~m10,
"Employed (Reference)", "", "", "", "", "", "", "", "", "", "", #1
"White (Reference)", "", "", "", "", "", "", "", "", "", "", #3
"Prior Industry Experience: No (Reference)", "", "", "", "", "", "", "", "", "", "", #5
"Male (Reference)", "", "", "", "", "", "", "", "", "", "", # 8
"US Born (Reference)", "", "", "", "", "", "", "", "", "", "", #12
"Not Married (Reference)", "", "", "", "", "", "", "", "", "", "", #14
"Not Parent(Reference)", "", "", "", "", "", "", "", "", "", "", #16
"High School or Less (Reference)", "", "", "", "", "", "", "", "", "", "", # 18
"Professional, Scientific, and Management, and Administrative, and Waste Management Services (Reference)", "", "", "", "", "", "", "", "", "", "",
"Calendar Year: 2014 (Reference)", "", "", "", "", "", "", "", "", "", ""
)
attr(rows_to_add, 'position') <- c(1, 3, 5, 8, 12, 14, 16, 18, 23, 36)
tbl4_unemp_models_rse <- modelsummary(list(unemp_m1_plm,
unemp_m2_plm,
unemp_m3_plm,
unemp_m4_plm,
unemp_m5_plm,
unemp_m6_plm,
unemp_m7_plm,
unemp_m8_plm,
unemp_m9_plm,
unemp_m10_plm),
coef_map = coef_map,
add_rows = rows_to_add,
estimate = "{estimate} ({std.error}){stars}",
vcov = "robust",
statistic = NULL,
title = "Table 4 Robust SE Unemployment predicting Log Annual Earnings",
output = "huxtable",
notes = "Significance levels: + p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")
tbl4_unemp_models_rse
addWorksheet(wb, "Tbl 4 Reg Unemp Earn RSE")
writeData(wb, tbl4_unemp_models_rse, sheet = "Tbl 4 Reg Unemp Earn RSE")
library(plm)
status_m1_plm <- plm(ln_tpearn_annual ~ y1_status_v2,
data = person_year,
index = c("ssuid_spanel_pnum", "calyear"),
model = "random",
random.method = "walhus")
status_m2_plm <- plm(ln_tpearn_annual ~ y1_status_v2  +
race_eth_fct_cpsd +
educ_fct +
tage +
age_sq +
sex_fct +
immig_fct +
married +
parent_std +
calyear  , data = person_year,
index = c("ssuid_spanel_pnum", "calyear"),
model = "random",random.method = "walhus")
status_m3_plm <- update(status_m2_plm, . ~ . + industry_numeric)
status_m4_plm <- update(status_m3_plm, . ~ . + industry_experience)
status_m5_plm <- update(status_m4_plm, . ~ . + industry_experience*y1_status_v2)
status_m6_plm <- update(status_m4_plm, . ~ . + ln_thnetworth)
status_m7_plm <- update(status_m2_plm, . ~ . + industry_experience)
status_m8_plm <- update(status_m2_plm, . ~ . + mode_industry)
status_m9_plm <- update(status_m8_plm, . ~ . + industry_experience)
status_m10_plm <- update(status_m9_plm, . ~ . + ln_thnetworth)
coef_map_status <- build_coef_map_ordered(list(status_m1_plm,
status_m2_plm,
status_m3_plm,
status_m4_plm,
status_m5_plm,
status_m6_plm,
status_m7_plm,
status_m8_plm,
status_m9_plm,
status_m10_plm), mapping, desired_order)
rows_to_add_status <- tribble(
~term, ~m1, ~m2, ~m3, ~m4, ~m5, ~m6, ~m7, ~m8, ~m9, ~m10,
"Wage & Salary (Reference)", "", "", "", "", "", "", "", "", "", "", #1
"White (Reference)", "", "", "", "", "", "", "", "", "", "", #3
"Prior Industry Experience: No (Reference)", "", "", "", "", "", "", "", "", "", "", #5
"Male (Reference)", "", "", "", "", "", "", "", "", "", "", # 8
"US Born (Reference)", "", "", "", "", "", "", "", "", "", "", #12
"Not Married (Reference)", "", "", "", "", "", "", "", "", "", "", #14
"Not Parent(Reference)", "", "", "", "", "", "", "", "", "", "", #16
"High School or Less (Reference)", "", "", "", "", "", "", "", "", "", "", # 18
"Professional, Scientific, and Management, and Administrative, and Waste Management Services (Reference)", "", "", "", "", "", "", "", "", "", "",
"Calendar Year: 2014 (Reference)", "", "", "", "", "", "", "", "", "", ""
)
attr(rows_to_add_status, 'position') <- c(1, 4, 6, 10, 14, 16, 18, 20, 25, 38)
tbl5_status_models_rse <- modelsummary(list(status_m1_plm,
status_m2_plm,
status_m3_plm,
status_m4_plm,
status_m5_plm,
status_m6_plm,
status_m7_plm,
status_m8_plm,
status_m9_plm,
status_m10_plm),
coef_map = coef_map_status,
add_rows = rows_to_add_status,
estimate = "{estimate} ({std.error}){stars}",
vcov = "robust",
statistic = NULL,
title = "Table 5 Robust SE Y1 Status predicting Log Annual Earnings",
output = "huxtable",
notes = "Significance levels: + p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")
tbl5_status_models_rse
addWorksheet(wb, "Tbl 5 Reg Status Earn RSE")
writeData(wb, tbl5_status_models_rse, sheet = "Tbl 5 Reg Status Earn RSE")
unemp3_m1_plm <- plm(ln_tpearn_annual ~ unemp_f12_3,
data = person_year,
index = c("ssuid_spanel_pnum", "calyear"),
model = "random",
random.method = "walhus")
unemp3_m2_plm <- plm(ln_tpearn_annual ~ unemp_f12_3  +
race_eth_fct_cpsd +
educ_fct +
tage +
age_sq +
sex_fct +
immig_fct +
married +
parent_std +
calyear , data = person_year,
index = c("ssuid_spanel_pnum", "calyear"),
model = "random",random.method = "walhus")
unemp3_m3_plm <- update(unemp3_m2_plm, . ~. + industry_numeric)
unemp3_m4_plm <- update(unemp3_m3_plm, . ~ . + industry_experience)
unemp3_m5_plm <- update(unemp3_m4_plm, . ~ . + industry_experience*unemp_f12_3)
unemp3_m6_plm <- update(unemp3_m4_plm, . ~ . + ln_thnetworth)
unemp3_m7_plm <- update(unemp_m7_plm, . ~ .  -unemp_f12_6 + unemp_f12_3 )
unemp3_m8_plm <- update(unemp_m8_plm, . ~ .  -unemp_f12_6 + unemp_f12_3 )
unemp3_m9_plm <- update(unemp_m9_plm, . ~ .  -unemp_f12_6 + unemp_f12_3 )
unemp3_m10_plm <- update(unemp_m10_plm, . ~ .  -unemp_f12_6 + unemp_f12_3 )
coef_map_unemp3 <- build_coef_map_ordered(list(unemp3_m1_plm,
unemp3_m2_plm,
unemp3_m3_plm,
unemp3_m4_plm,
unemp3_m5_plm,
unemp3_m6_plm,
unemp3_m7_plm,
unemp3_m8_plm,
unemp3_m9_plm,
unemp3_m10_plm), mapping, desired_order)
tbl6_unemp_models_rse <- modelsummary(list(unemp3_m1_plm,
unemp3_m2_plm,
unemp3_m3_plm,
unemp3_m4_plm,
unemp3_m5_plm,
unemp3_m6_plm,
unemp3_m7_plm,
unemp3_m8_plm,
unemp3_m9_plm,
unemp3_m10_plm),
coef_map = coef_map_unemp3,
add_rows = rows_to_add, # safe to use the original rows here
estimate = "{estimate} ({std.error}){stars}",
vcov = "robust",
statistic = NULL,
title = "Table 6 Robust SE Unemployment 3+ predicting Log Annual Earnings",
output = "huxtable",
notes = "Significance levels: + p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")
tbl6_unemp_models_rse
addWorksheet(wb, "Tbl 6 Reg Unemp3 Earn RSE")
writeData(wb, tbl6_unemp_models_rse, sheet = "Tbl 6 Reg Unemp3 Earn RSE")
tbl7_df <- person_year %>% filter(y1_status_v2 != "Self-Employed")
unemp_ws_m1 <- update(unemp_m1_plm, . ~., data = tbl7_df)
unemp_ws_m2 <- update(unemp_m2_plm, . ~. , data = tbl7_df)
unemp_ws_m3 <- update(unemp_m3_plm, . ~. , data = tbl7_df)
unemp_ws_m4 <- update(unemp_m4_plm, . ~. , data = tbl7_df)
unemp_ws_m5 <- update(unemp_m5_plm, . ~. , data = tbl7_df)
unemp_ws_m6 <- update(unemp_m6_plm, . ~. , data = tbl7_df)
unemp_ws_m7 <- update(unemp_m7_plm, . ~. , data = tbl7_df)
unemp_ws_m8 <- update(unemp_m8_plm, . ~. , data = tbl7_df)
unemp_ws_m9 <- update(unemp_m9_plm, . ~. , data = tbl7_df)
unemp_ws_m10 <- update(unemp_m10_plm, . ~. , data = tbl7_df)
tbl7_unemp_ws_models <- modelsummary(list(unemp_ws_m1,
unemp_ws_m2,
unemp_ws_m3,
unemp_ws_m4,
unemp_ws_m5,
unemp_ws_m6,
unemp_ws_m7,
unemp_ws_m8,
unemp_ws_m9,
unemp_ws_m10),
## safe to use the original coef_map and rows_to add since only the sample has changed for this one
coef_map = coef_map,
add_rows = rows_to_add,
estimate = "{estimate} ({std.error}){stars}",
vcov = "robust",
statistic = NULL,
title = "Table 7 Unemployment predicting Log Annual Earnings",
output = "huxtable",
notes = "Significance levels: + p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")
tbl7_unemp_ws_models
addWorksheet(wb, "Tbl 7 Reg Unemp Earn WS")
writeData(wb, tbl7_unemp_ws_models, sheet = "Tbl 7 Reg Unemp Earn WS")
objs <- ls(pattern = "^unemp|^status")
library(car)
vif_df <- map_dfr(objs, function(m) {
model <- get(m)
tryCatch(
{
as.data.frame(vif(model)) %>%
mutate(variable = rownames(.),
model = m, .before = 1)
},
error = function(e) {
message("VIF failed for:", m)
}
)
})
write_csv(vif_df, "vif_df.csv")
## HLM Unemployment Models
library(lme4)
person_year <- person_year %>%
mutate(calyear = as.factor(calyear))
# Base model with random intercepts for Household and Person
unemp_m1_hlm <- lmer(ln_tpearn_annual ~ unemp_f12_6 + (1 | shhadid) + (1 | ssuid_spanel_pnum),
data = person_year)
# Full Control Model
unemp_m2_hlm <- lmer(ln_tpearn_annual ~ unemp_f12_6  +
race_eth_fct_cpsd +
educ_fct +
tage +
age_sq +
sex_fct +
immig_fct +
married +
parent_std +
calyear +
(1 | shhadid) + (1 | ssuid_spanel_pnum),
data = person_year)
# Updating to match other model strucure
unemp_m3_hlm <- update(unemp_m2_hlm, . ~. + industry_numeric)
unemp_m4_hlm <- update(unemp_m3_hlm, . ~ . + industry_experience)
unemp_m5_hlm <- update(unemp_m4_hlm, . ~ . + industry_experience*unemp_f12_6)
unemp_m6_hlm <- update(unemp_m4_hlm, . ~ . + ln_thnetworth)
unemp_m7_hlm <- update(unemp_m2_hlm, . ~ . + industry_experience)
unemp_m8_hlm <- update(unemp_m2_hlm, . ~ . + mode_industry)
unemp_m9_hlm <- update(unemp_m8_hlm, . ~ . + industry_experience)
unemp_m10_hlm <- update(unemp_m9_hlm, . ~. + ln_thnetworth)
# Generate Table
tbl4_unemp_hlm <- modelsummary(list(unemp_m1_hlm,
unemp_m2_hlm,
unemp_m3_hlm,
unemp_m4_hlm,
unemp_m5_hlm,
unemp_m6_hlm,
unemp_m7_hlm,
unemp_m8_hlm,
unemp_m9_hlm,
unemp_m10_hlm),
coef_map = coef_map,
add_rows = rows_to_add,
estimate = "{estimate} ({std.error}){stars}",
statistic = NULL,
title = "Table 4 HLM: Unemployment predicting Log Annual Earnings",
output = "huxtable",
notes = "Significance levels: + p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")
# Add to workbook
addWorksheet(wb, "Tbl 4 HLM Unemp")
writeData(wb, tbl4_unemp_hlm, sheet = "Tbl 4 HLM Unemp")
## HLM Status Models
status_m1_hlm <- lmer(ln_tpearn_annual ~ y1_status_v2 + (1 | shhadid) + (1 | ssuid_spanel_pnum),
data = person_year)
status_m2_hlm <- lmer(ln_tpearn_annual ~ y1_status_v2  +
race_eth_fct_cpsd +
educ_fct +
tage +
age_sq +
sex_fct +
immig_fct +
married +
parent_std +
calyear +
(1 | shhadid) + (1 | ssuid_spanel_pnum),
data = person_year)
status_m3_hlm <- update(status_m2_hlm, . ~ . + industry_numeric)
status_m4_hlm <- update(status_m3_hlm, . ~ . + industry_experience)
status_m5_hlm <- update(status_m4_hlm, . ~ . + industry_experience*y1_status_v2)
status_m6_hlm <- update(status_m4_hlm, . ~ . + ln_thnetworth)
status_m7_hlm <- update(status_m2_hlm, . ~ . + industry_experience)
status_m8_hlm <- update(status_m2_hlm, . ~ . + mode_industry)
status_m9_hlm <- update(status_m8_hlm, . ~ . + industry_experience)
status_m10_hlm <- update(status_m9_hlm, . ~ . + ln_thnetworth)
# Generate Table
tbl5_status_hlm <- modelsummary(list(status_m1_hlm,
status_m2_hlm,
status_m3_hlm,
status_m4_hlm,
status_m5_hlm,
status_m6_hlm,
status_m7_hlm,
status_m8_hlm,
status_m9_hlm,
status_m10_hlm),
coef_map = coef_map_status,
add_rows = rows_to_add_status,
estimate = "{estimate} ({std.error}){stars}",
statistic = NULL,
title = "Table 5 HLM: Y1 Status predicting Log Annual Earnings",
output = "huxtable",
notes = "Significance levels: + p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")
# Add to workbook
addWorksheet(wb, "Tbl 5 HLM Status")
writeData(wb, tbl5_status_hlm, sheet = "Tbl 5 HLM Status")
unemp3_m1_hlm <- lmer(ln_tpearn_annual ~ unemp_f12_3 + (1 | shhadid) + (1 | ssuid_spanel_pnum),
data = person_year)
unemp3_m2_hlm <- lmer(ln_tpearn_annual ~ unemp_f12_3  +
race_eth_fct_cpsd +
educ_fct +
tage +
age_sq +
sex_fct +
immig_fct +
married +
parent_std +
calyear +
(1 | shhadid) + (1 | ssuid_spanel_pnum),
data = person_year)
unemp3_m3_hlm <- update(unemp3_m2_hlm, . ~. + industry_numeric)
unemp3_m4_hlm <- update(unemp3_m3_hlm, . ~ . + industry_experience)
unemp3_m5_hlm <- update(unemp3_m4_hlm, . ~ . + industry_experience*unemp_f12_3)
unemp3_m6_hlm <- update(unemp3_m4_hlm, . ~ . + ln_thnetworth)
unemp3_m7_hlm <- update(unemp3_m2_hlm, . ~ . + industry_experience)
unemp3_m8_hlm <- update(unemp3_m2_hlm, . ~ . + mode_industry)
unemp3_m9_hlm <- update(unemp3_m8_hlm, . ~ . + industry_experience)
unemp3_m10_hlm <- update(unemp3_m9_hlm, . ~. + ln_thnetworth)
tbl6_unemp3_hlm <- modelsummary(list(unemp3_m1_hlm,
unemp3_m2_hlm,
unemp3_m3_hlm,
unemp3_m4_hlm,
unemp3_m5_hlm,
unemp3_m6_hlm,
unemp3_m7_hlm,
unemp3_m8_hlm,
unemp3_m9_hlm,
unemp3_m10_hlm),
coef_map = coef_map_unemp3,
add_rows = rows_to_add,
estimate = "{estimate} ({std.error}){stars}",
statistic = NULL,
title = "Table 6 HLM: 3-month Unemployment predicting Log Annual Earnings",
output = "huxtable",
notes = "Significance levels: + p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")
# Add to workbook
addWorksheet(wb, "Tbl 6 HLM Unemp3")
writeData(wb, tbl6_unemp3_hlm, sheet = "Tbl 6 HLM Unemp3")
output_name <- paste0("working_paper_outputs_", format(Sys.Date(), "%Y%m%d"), ".xlsx")
saveWorkbook(wb,output_name, overwrite = TRUE)
