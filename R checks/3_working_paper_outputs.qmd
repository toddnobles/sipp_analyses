---
title: "Self-Employed Sample Outputs"
author: "Todd Nobles"
format: 
  html:
    toc: true
  docx:
    toc: true
  pdf: 
    toc: true
execute:
  echo: true
  
---

Read in our working dataset created in data_prep.qmd

```{r}
#| message: false
rm(list = ls())
library(tidyverse)
library(lme4)

se_sample <- readRDS("se_sample_5_cleanest.rds") %>% ungroup()
```


```{r creating person-level file for summary stats}
se_sample <- se_sample %>% 
  mutate(y1_status_v2 = factor(y1_status_v2, labels = c("W&S", "Self-Employed", "Unemployed")))

person_level <- se_sample %>%
  arrange(ssuid_spanel_pnum, swave, monthcode) %>% 
  # getting to person-year level
  group_by(ssuid_spanel_pnum, swave) %>%
  summarize(# the following three are all constant within individuals so we just grab their first value
    y1_status_v2 = first(y1_status_v2),
    race_eth_fct_cpsd = first(race_eth_fct_cpsd),
    sex_fct = first(sex_fct),
    # here we take their highest education value ever observed 
    educ_fct = last(educ_fct),
    tpearn_annual = sum(tpearn),
    industry = first(industry_fct)) %>% 
  # summarizing to person-level 
  group_by(ssuid_spanel_pnum) %>% 
  summarize(
    avg_earnings = mean(tpearn_annual),
    median_earnings = quantile(tpearn_annual, .5),
    y1_status_v2 = first(y1_status_v2),
    race_eth_fct_cpsd = first(race_eth_fct_cpsd),
    sex_fct = first(sex_fct),
    # here we take their highest education value ever observed 
    educ_fct = last(educ_fct),
    industry = first(industry)
  ) %>%
  ungroup()



```




```{r, setting labels for person-level file}
#| message: false
library(labelled)
person_level <- person_level %>%
  set_variable_labels(
    avg_earnings = "Avg earnings (tpearn)",
    sex_fct = "Sex",
    y1_status_v2 = "Initial Status",
    race_eth_fct_cpsd = "Race/Ethnicity",
    educ_fct = "Education",
    industry = "Industry")
```


## Table 1 
Descriptive statistics for self-employed sample by initial employment status
Person-level table
```{r}
library(gtsummary)
tbl1 <- person_level %>%
  select(avg_earnings, race_eth_fct_cpsd, y1_status_v2, educ_fct, sex_fct, industry) %>% 
  tbl_summary(by = y1_status_v2,
             statistic = list(all_continuous() ~ "{mean} [{median}] ({sd})")) %>% 
  add_overall()

tbl1 
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "Table 1")
writeData(wb, tbl1 , sheet = "Table 1")

```
## Table 2 (various versions) of descriptive statistics 

### Table 2 Summary Statistics for earnings by group
To create the table below, we use the same dataset as above and generate a person-level average of their annual earnings across years. 
```{r}
#| message: false
library(modelsummary)

tbl2 <- datasummary(
    (` ` = avg_earnings * (Education =educ_fct)) +
        (` `= avg_earnings * (Race = race_eth_fct_cpsd)) +
        (` `= avg_earnings * (Sex = sex_fct)) ~ y1_status_v2* (mean+ sd + N) ,
    data = person_level,
    fmt = fmt_sprintf("%.0f"),
    title = 'Earnings Comparison by Demographic Characteristics', 
    note = "This table displays the group-level averages and standard deviations for the person-level average earnings.",
    output = "gt"
)

tbl2 
addWorksheet(wb, "Table 2")
writeData(wb, tbl2, sheet = "Table 2")

```



```{r function to log transform vars with negative values in them}
# feed it a vector to convert to log transform that accounts for negative values 
log_transform <- function(x) {
  min_x <- min(x)*-1
  log(x + min_x + 1)
}
```


```{r creating person-year level df }

## getting down to a dataset that has their demographic vars and yearly earnings at the person-year level
temp <- se_sample %>% 
  filter(monthcode %% 12 == 0) %>% 
  select(ssuid_spanel_pnum, 
         y1_status_v2, 
         unemp_f12,
         educ_fct, 
         race_eth_fct_cpsd,
         sex_fct,
         immig_fct,
         parent_std,
         industry_fct,
         tage,
         calyear,
         prftb, 
         wpfinwgt,
         val,
         profposi,
         prof10k) %>% 
  mutate(unemp_f12_6 = factor(ifelse(unemp_f12 >=6, 1,0), labels = c("Not Unemployed", "Unemployed")),
         industry_fct = as_factor(industry_fct),
         industry_num = as.numeric(industry_fct))

temp_earnings <- se_sample %>% 
  group_by(ssuid_spanel_pnum, calyear) %>% 
  summarize(tpearn_annual= sum(tpearn)) %>% 
  ungroup()


person_year <- left_join(temp_earnings, temp, by = c("ssuid_spanel_pnum", "calyear")) %>% 
    mutate(ln_tpearn_annual = log_transform(tpearn_annual))

```


```{r setting variable labels for person_year df}
person_year <- person_year %>%
  set_variable_labels(
    ln_tpearn_annual = "Log earnings (tpearn)",
    sex_fct = "Sex",
    y1_status_v2 = "Initial Status",
    race_eth_fct_cpsd = "Race",
    educ_fct = "Education",
    unemp_f12_6 = "Unemployed 6-months",
    industry_fct = "Industry",
    tage = "Age",
    immig_fct = "Nativity",
    calyear = "Year"
  )
    
```

```{r writing out the person level files}
write_csv(person_level, "person_level_se_clean_5.csv")
write_csv(person_year, "person_year_se_clean_5.csv")
haven::write_dta(person_year, "person_year_se_clean5.dta")
```


### Table 2 Person-year level 
Do we get similar results if we use person-year level dataset? 

```{r, summary table with person-year level}

tbl2_person_year <- datasummary(
  (` ` = tpearn_annual * (Education = educ_fct)) +
    (` ` = tpearn_annual * (Race = race_eth_fct_cpsd)) +
    (` ` = tpearn_annual * (Sex = sex_fct)) ~ y1_status_v2 * (mean + sd + N) ,
  data = person_year,
  fmt = fmt_sprintf("%.0f"),
  title = 'Earnings Comparison by Demographic Characteristics',
  note = "This table displays the group-level averages and standard deviations for the person-level average earnings.",
  output = "gt"
)

tbl2_person_year

addWorksheet(wb, "Table 2 Person Year")
writeData(wb, tbl2_person_year, sheet = "Table 2 Person Year")
```



What about if we incorporate weights? 

```{r creating survey object for yearly estimates}
library(survey)
library(srvyr)
py_svy <- person_year %>% as_survey_design(ids= ssuid_spanel_pnum, weights = wpfinwgt)
```

### Table 2 Weighted
```{r}
wtd1<- py_svy %>% 
  group_by(y1_status_v2,educ_fct) %>% 
  summarize(earnings = survey_mean(tpearn_annual))  %>% 
  select(-earnings_se) %>% 
  pivot_wider(
    names_from = y1_status_v2,
    values_from = c(earnings),
    names_sep = "_"
  ) %>%
  mutate(across(where(is.numeric), round, digits = 0))  %>%  
  gt::gt()


wtd2 <- py_svy %>% 
  group_by(y1_status_v2,race_eth_fct_cpsd) %>% 
  summarize(earnings = survey_mean(tpearn_annual))  %>% 
  select(-earnings_se) %>% 
  pivot_wider(
    names_from = y1_status_v2,
    values_from = c(earnings),
    names_sep = "_"
  ) %>% 
  mutate(across(where(is.numeric), round, digits = 0)) %>% 
  gt::gt()


wtd3 <- py_svy %>% 
  group_by(y1_status_v2,sex_fct) %>% 
  summarize(earnings = survey_mean(tpearn_annual))  %>% 
  select(-earnings_se) %>% 
  pivot_wider(
    names_from = y1_status_v2,
    values_from = c(earnings),
    names_sep = "_"
  ) %>% 
  mutate(across(where(is.numeric), round, digits = 0)) %>% 
  gt::gt()


tbl2_wtd <- gt::gt_group(wtd1, wtd2, wtd3)

wtd1 
wtd2
wtd3


addWorksheet(wb, "Table 2 Person Level Weighted")
writeData(wb, tbl2_person_year, sheet = "Table 2 Person Level Weighted")
```



# Regressions for earnings
<!-- Using person-year level data -->
<!-- https://asdfree.com/survey-of-income-and-program-participation-sipp.html -->

<!-- https://cran.r-project.org/web/packages/robustlmm/vignettes/rlmer.pdf  -->
<!-- clubSandwich -->


## Earnings Unemployment models 
```{r unemployment earnings models }
# confirmed with checking plm version of the model that these warnings can be ignored but shifting to plm version anyways for ease of mind
person_year <- person_year %>% 
  mutate(age_sq = tage^2) %>% 
  set_variable_labels(age_sq = "Age Squared")
  


library(plm)
unemp_m1_plm <- plm(ln_tpearn_annual ~ unemp_f12_6  + 
                   educ_fct + 
                   tage + 
                   age_sq + 
                   sex_fct + 
                   immig_fct + 
                   calyear + 
                   industry_fct , data = person_year,
                   index = c("ssuid_spanel_pnum", "calyear"), 
                   model = "random")

unemp_m2_plm <- update(unemp_m1_plm, . ~. + race_eth_fct_cpsd)
unemp_m3_plm <- update(unemp_m2_plm, . ~. + race_eth_fct_cpsd:unemp_f12_6)
unemp_m4_plm <- update(unemp_m2_plm, . ~. + sex_fct:unemp_f12_6)

unemp_m1_plm_wt <- update(unemp_m1_plm, . ~. , weights = wpfinwgt)
unemp_m2_plm_wt <- update(unemp_m1_plm_wt, . ~. + race_eth_fct_cpsd)
unemp_m3_plm_wt <- update(unemp_m2_plm_wt, . ~. + race_eth_fct_cpsd:unemp_f12_6)
unemp_m4_plm_wt <- update(unemp_m2_plm_wt, . ~. + sex_fct:unemp_f12_6)

```


### Table 3 Unemployment Robust SEs

```{r table unemp earnings robust se }


tbl3_unemp_models_rse <- modelsummary(list(unemp_m1_plm,
                                           unemp_m2_plm, 
                                           unemp_m3_plm, 
                                           unemp_m4_plm), 
                                      coef_rename = TRUE, 
                                      estimate = "{estimate} ({std.error}){stars}",
                                      vcov = "robust",
                                      statistic = NULL,
                                      title = "Table 3 Robust SE Unemployment predciting Log Annual Earnings", 
                                      output = "gt")

tbl3_unemp_models_rse
addWorksheet(wb, "Tbl 3 Reg Unemp Earn RSE")
writeData(wb, tbl3_unemp_models_rse, sheet = "Tbl 3 Reg Unemp Earn RSE")


```

### Table 3 Unemployment Weighted
```{r table unemp earnings regular se weighted}
tbl3_unemp_models_wts <- modelsummary(list(unemp_m1_plm_wt,
                   unemp_m2_plm_wt,
                   unemp_m3_plm_wt,
                   unemp_m4_plm_wt), 
                                  coef_rename = TRUE, 
                                  estimate = "{estimate} ({std.error}){stars}",
                           statistic = NULL,
                           title = "Table 3 Weights Unemployment predciting Log Annual Earnings", 
             output = "gt")
tbl3_unemp_models_wts

addWorksheet(wb, "Tbl 3 Reg Unemp Earn WT")
writeData(wb, tbl3_unemp_models_wts, sheet = "Tbl 3 Reg Unemp Earn WT")

```



## Earnings Year One Status Models
```{r y1_status_models}
library(plm)
status_m1_plm <- plm(ln_tpearn_annual ~ y1_status_v2  + 
                   educ_fct + 
                   tage + 
                   age_sq + 
                   sex_fct + 
                   immig_fct + 
                   calyear + 
                   industry_fct , data = person_year,
                   index = c("ssuid_spanel_pnum", "calyear"), 
                   model = "random")

status_m2_plm <- update(status_m1_plm, . ~. + race_eth_fct_cpsd)
status_m3_plm <- update(status_m2_plm, . ~. + race_eth_fct_cpsd:y1_status_v2)
status_m4_plm <- update(status_m2_plm, . ~. + sex_fct:y1_status_v2)

status_m1_plm_wt <- update(status_m1_plm, . ~. , weights = wpfinwgt)
status_m2_plm_wt <- update(status_m1_plm_wt, . ~. + race_eth_fct_cpsd)
status_m3_plm_wt <- update(status_m2_plm_wt, . ~. + race_eth_fct_cpsd:y1_status_v2)
status_m4_plm_wt <- update(status_m2_plm_wt, . ~. + sex_fct:y1_status_v2)
```

### Table 4 Y1 Status 
```{r table y1_status models}
tbl4_status_earn <- modelsummary(list(status_m1_plm,
                   status_m2_plm,
                   status_m3_plm,
                   status_m4_plm), 
                                  coef_rename = TRUE, 
                                  estimate = "{estimate} ({std.error}){stars}",
                           statistic = NULL,
                           title = "Table 4  Y1 Status predicting Log Annual Earnings", 
             output = "gt")
tbl4_status_earn
addWorksheet(wb, "Tbl 4 Reg Status Earn")
writeData(wb, tbl3_unemp_models_wts, sheet = "Tbl 4 Reg Status Earn")
```

### Table 4 Y1 Status Robust SE
```{r table y1 earnings robust se }

tbl4_status_earn_rse <- modelsummary(list(status_m1_plm,
                   status_m2_plm,
                   status_m3_plm,
                   status_m4_plm), 
                                  coef_rename = TRUE, 
                                  estimate = "{estimate} ({std.error}){stars}",
                   vcov = "robust",
                           statistic = NULL,
                           title = "Table 4 RSE Y1 Status predicting Log Annual Earnings", 
             output = "gt")
tbl4_status_earn_rse
addWorksheet(wb, "Tbl 4 Reg Status Earn RSE")
writeData(wb, tbl4_status_earn_rse, sheet = "Tbl 4 Reg Status Earn RSE")
```

### Table 4 Y1 Status Weights
```{r table y1 status earnings regular se weighted}
tbl4_status_earn_wts <- modelsummary(list(status_m1_plm_wt,
                   status_m2_plm_wt,
                   status_m3_plm_wt,
                   status_m4_plm_wt), 
                                  coef_rename = TRUE, 
                                  estimate = "{estimate} ({std.error}){stars}",
                           statistic = NULL,
                           title = "Table 4 Weights Y1 Status predciting Log Annual Earnings", 
             output = "gt")
tbl4_status_earn_wts
addWorksheet(wb, "Tbl 4 Reg Status Earn WT")
writeData(wb, tbl4_status_earn_wts, sheet = "Tbl 4 Reg Status Earn WT")

```




# Profits Unemployment
```{r models for positive profit}
# models for profit
# m1_unemp_prftb <- glmer(profposi ~
#                    unemp_f12_6  +
#                    educ_fct +
#                    tage +
#                    age_sq +
#                    sex_fct +
#                    immig_fct +
#                    industry_fct +
#                    as.factor(calyear) +
#                    (1 | ssuid_spanel_pnum),
#                    control = glmerControl(optimizer = "nloptwrap", 
#                                           calc.derivs = FALSE),
#                  data = person_year, family = binomial)
# 
# 
# m2_unemp_prftb <- update(m1_unemp_prftb, . ~ .  + race_eth_fct_cpsd)
# m3_unemp_prftb <- update(m2_unemp_prftb, . ~ . + race_eth_fct_cpsd:unemp_f12_6)
# m4_unemp_prftb <- update(m2_unemp_prftb, . ~ . + sex_fct:unemp_f12_6)


# m1_unemp_prftb_wt <- glmer(profposi ~
#                    unemp_f12_6  +
#                    educ_fct +
#                    tage +
#                    age_sq +
#                    sex_fct +
#                    immig_fct +
#                    industry_fct +
#                    as.factor(calyear) +
#                    (1 | ssuid_spanel_pnum),
#                    control = glmerControl(optimizer = "nloptwrap", 
#                                           calc.derivs = FALSE),
#                  data = person_year, family = binomial,
#                  weights = wpfinwgt)
# 
# 
# m2_unemp_prftb_wt <- update(m1_unemp_prftb_wt, . ~ .  + race_eth_fct_cpsd)
# m3_unemp_prftb_wt <- update(m2_unemp_prftb_wt, . ~ . + race_eth_fct_cpsd:unemp_f12_6)
# m4_unemp_prftb_wt <- update(m2_unemp_prftb_wt, . ~ . + sex_fct:unemp_f12_6)



```





```{r models for 10k profit}
# m1_unemp_prftb10 <- glmer(prof10k ~
#                    unemp_f12_6  +
#                    educ_fct +
#                    tage +
#                    age_sq +
#                    sex_fct +
#                    immig_fct +
#                   as.factor(calyear) +
#                    (1 | ssuid_spanel_pnum),
#                    control = glmerControl(optimizer = "nloptwrap", 
#                                           calc.derivs = FALSE),
#                  data = person_year, family = binomial)
# 
# 
# m2_unemp_prftb10 <- update(m1_unemp_prftb10, . ~ .  + race_eth_fct_cpsd)
# m3_unemp_prftb10 <- update(m2_unemp_prftb10, . ~ . + race_eth_fct_cpsd:unemp_f12_6)
# m4_unemp_prftb10 <- update(m2_unemp_prftb10, . ~ . + sex_fct:unemp_f12_6)

# 
# m1_unemp_prftb10_wt <- glmer(prof10k ~
#                    unemp_f12_6  +
#                    educ_fct +
#                    tage +
#                    age_sq +
#                    sex_fct +
#                    immig_fct +
#                   as.factor(calyear) +
#                    (1 | ssuid_spanel_pnum),
#                    control = glmerControl(optimizer = "nloptwrap", 
#                                           calc.derivs = FALSE),
#                  data = person_year, family = binomial,
#                  weights = wpfinwgt)
# 
# m2_unemp_prftb10_wt <- update(m1_unemp_prftb10_wt, . ~ .  + race_eth_fct_cpsd)
# m3_unemp_prftb10_wt <- update(m2_unemp_prftb10_wt, . ~ . + race_eth_fct_cpsd:unemp_f12_6)
# m4_unemp_prftb10_wt <- update(m2_unemp_prftb10_wt, . ~ . + sex_fct:unemp_f12_6)


```


### Table 5 Unemployment and Positive Profit
```{r}
# tbl5_unemp_posprof <- modelsummary(list(m1_unemp_prftb,
#                    m2_unemp_prftb,
#                    m3_unemp_prftb,
#                    m4_unemp_prftb), 
#                                   coef_rename = TRUE, 
#                                   estimate = "{estimate} ({std.error}){stars}",
#                            statistic = NULL,
#                    vcov = "robust", 
#                            title = "Table 5 Unemp Predicting Positive Profit", 
#              output = "gt")
# 
# tbl5_unemp_posprof
# 
# addWorksheet(wb, "Tbl 5 Reg Unemp Profit")
# writeData(wb, tbl5_unemp_posprof, sheet = "Tbl 5 Reg Unemp Profit")

```

### Table 5 Unemployment and Postive Profit with Weights 
```{r}
# 
# tbl5_unemp_posprof_wt <- modelsummary(list(m1_unemp_prftb_wt,
#                    m2_unemp_prftb_wt,
#                    m3_unemp_prftb_wt,
#                    m4_unemp_prftb_wt), 
#                                   coef_rename = TRUE, 
#                                   estimate = "{estimate} ({std.error}){stars}",
#                            statistic = NULL,
#                            title = "Table 5 Weighted Unemp Predicting Positive Profit", 
#              output = "gt")
# 
# tbl5_unemp_posprof_wt
# 
# addWorksheet(wb, "Tbl 5 Reg Unemp Profit WTD")
# writeData(wb, tbl5_unemp_posprof_wt, sheet = "Tbl 5 Reg Unemp Profit WTD")
```


### Table 6 Unemployment and 10k Profit 

```{r}

# tbl6_unemp_prof10k <- modelsummary(list(m1_unemp_prftb10,
#                    m2_unemp_prftb10,
#                    m3_unemp_prftb10,
#                    m4_unemp_prftb10),
#                                   coef_rename = TRUE,
#                                   estimate = "{estimate} ({std.error}){stars}",
#                  vcov = "robust",
#                            statistic = NULL,
#                            title = "Table 6 Unemp Predicting 10k Profit",
#              output = "gt")
# 
# tbl6_unemp_prof10k
# addWorksheet(wb, "Tbl 6 Reg Unemp 10k Profit")
# writeData(wb, tbl5_unemp_posprof_wt, sheet = "Tbl 6 Reg Unemp 10k Profit")


```

### Table 6 Unemployment and 10k Profit with Weights 

```{r}


# tbl6_unemp_prof10k_wt <- modelsummary(list(m1_unemp_prftb10_wt,
#                    m2_unemp_prftb10_wt,
#                    m3_unemp_prftb10_wt,
#                    m4_unemp_prftb10_wt), 
#                                   coef_rename = TRUE, 
#                                   estimate = "{estimate} ({std.error}){stars}",
#                            statistic = NULL,
#                            title = "Table 6 Weighted Unemp Predicting Positive Profit", 
#              output = "gt")
# 
# tbl6_unemp_prof10k_wt
# 
# addWorksheet(wb, "Tbl 6 Reg Unemp 10k Profit WTD")
# writeData(wb, tbl6_unemp_prof10k_wt, sheet = "Tbl 6 Reg Unemp 10k Profit WTD")
```


```{r}
saveWorkbook(wb, paste0("working_paper_outputs",Sys.Date(),".xlsx"), overwrite = TRUE)
```

