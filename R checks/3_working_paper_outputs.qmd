---
title: "Self-Employed Sample Outputs"
author: "Todd Nobles"
format: 
  html:
    toc: true
    embed-resources: true 
  docx:
    toc: true
  pdf: 
    toc: true
execute:
  echo: true
  
---
# Read in and final data polishing for presentation
Read in our working dataset created in data_prep.qmd

```{r}
#| message: false
rm(list = ls())
library(tidyverse)
library(lme4)

se_sample <- readRDS("se_sample_5_cleanest.rds") 
```

## Adjusting for inflation 
```{r}

table(se_sample$calyear)

se_sample <- se_sample %>% 
  mutate(
    tpearn_inf = case_when(
      calyear == 2014 ~ tpearn* 292.7/236.7,
      calyear == 2015 ~ tpearn*292.7/237,
      calyear == 2016 ~ tpearn*292.7/240.0,
      calyear == 2018 ~ tpearn*292.7/251.1,
      calyear == 2019 ~ tpearn*292.7/255.7,
      calyear == 2020 ~ tpearn*292.7/258.8,
      calyear == 2021 ~ tpearn*292.7/271,
      calyear == 2022 ~ tpearn,
      .default = NA
  ),
    msum_inf = case_when(
      calyear == 2014 ~ msum* 292.7/236.7,
      calyear == 2015 ~ msum*292.7/237,
      calyear == 2016 ~ msum*292.7/240.0,
      calyear == 2018 ~ msum*292.7/251.1,
      calyear == 2019 ~ msum*292.7/255.7,
      calyear == 2020 ~ msum*292.7/258.8,
      calyear == 2021 ~ msum*292.7/271,
      calyear == 2022 ~ msum,
      .default = NA
    ),
  prftb_inf = case_when(
      calyear == 2014 ~ prftb* 292.7/236.7,
      calyear == 2015 ~ prftb*292.7/237,
      calyear == 2016 ~ prftb*292.7/240.0,
      calyear == 2018 ~ prftb*292.7/251.1,
      calyear == 2019 ~ prftb*292.7/255.7,
      calyear == 2020 ~ prftb*292.7/258.8,
      calyear == 2021 ~ prftb*292.7/271,
      calyear == 2022 ~ prftb,
      .default = NA
  )
)
```




```{r creating person-level file for summary stats}
se_sample <- se_sample %>% 
  mutate(y1_status_v2 = factor(y1_status_v2, labels = c("W&S", "Self-Employed", "Unemployed")))

person_level <- se_sample %>%
  arrange(ssuid_spanel_pnum, swave, monthcode) %>% 
  # getting to person-year level
  group_by(ssuid_spanel_pnum, swave) %>%
  summarize(# the following three are all constant within individuals so we just grab their first value
    y1_status_v2 = first(y1_status_v2),
    race_eth_fct_cpsd = first(race_eth_fct_cpsd),
    sex_fct = first(sex_fct),
    # here we take their highest education value ever observed 
    educ_fct = last(educ_fct),
    tpearn_annual = sum(tpearn_inf),
    industry = first(industry_fct),
    prftb = last(prftb_inf),
    profposi = last(profposi),
    prof10k = last(prof10k)) %>% 
  # summarizing to person-level 
  group_by(ssuid_spanel_pnum) %>% 
  summarize(
    avg_earnings = mean(tpearn_annual),
    median_earnings = quantile(tpearn_annual, .5),
    y1_status_v2 = first(y1_status_v2),
    race_eth_fct_cpsd = first(race_eth_fct_cpsd),
    sex_fct = first(sex_fct),
    # here we take their highest education value ever observed 
    educ_fct = last(educ_fct),
    industry = first(industry),
    avg_prftb = mean(prftb),
    median_prftb = quantile(prftb, .5),
    profposi = mean(profposi),
    prof10k = mean(prof10k)
  ) %>%
  ungroup()



```




```{r, setting labels for person-level file}
#| message: false
library(labelled)
person_level <- person_level %>%
  set_variable_labels(
    avg_earnings = "Avg earnings (tpearn)",
    sex_fct = "Sex",
    y1_status_v2 = "Initial Status",
    race_eth_fct_cpsd = "Race/Ethnicity",
    educ_fct = "Education",
    industry = "Industry",
    avg_prftb = "Avg profit",
    median_prftb = "Median profit",
    profposi = "Positive Profit",
    prof10k = "Profit >=10k")
```


## Table 2-rep
Descriptive statistics for self-employed sample by initial employment status
Person-level table
```{r}
library(gtsummary)

tbl2 <- person_level %>%
  select(avg_earnings, avg_prftb, y1_status_v2) %>% 
  tbl_summary(by = y1_status_v2,
             statistic = list(
    all_continuous() ~ c("{mean} ({sd})", "{median}")
  ),
  type = all_continuous() ~ "continuous2"
) %>% 
  add_overall()

tbl2
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "Table 2")
writeData(wb, tbl2 , sheet = "Table 2")
```


## Table 2-rep side counts
```{r}
tbl2_counts <- person_level %>%
  select(y1_status_v2, race_eth_fct_cpsd, sex_fct) %>% 
  tbl_summary(by = y1_status_v2,
             statistic = list(
    all_categorical() ~ "{n} ({p}%)"
  ),
  type = all_categorical() ~ "categorical"
) %>% 
  add_overall()
addWorksheet(wb, "Table 2 Counts")
writeData(wb, tbl2_counts , sheet = "Table 2 Counts")
```

## Table 3

To create the table below, we use the same dataset as above and generate a person-level average of their annual earnings across years. 
```{r}
#| message: false
library(modelsummary)

tbl3 <- datasummary(
        (` `= avg_earnings * (Race = race_eth_fct_cpsd)) +
        (` `= avg_earnings * (Sex = sex_fct)) ~ y1_status_v2* (mean+ sd + N) ,
    data = person_level,
    fmt = fmt_sprintf("%.0f"),
    title = 'Earnings Comparison by Demographic Characteristics', 
    note = "This table displays the group-level averages and standard deviations for the person-level average earnings.",
    output = "huxtable"
)

tbl3
addWorksheet(wb, "Table 3")
writeData(wb, tbl3, sheet = "Table 3")

```

```{r}
#| message: false

tbl3_profit <- datasummary(
        (` `= avg_prftb * (Race = race_eth_fct_cpsd)) +
        (` `= avg_prftb * (Sex = sex_fct)) ~ y1_status_v2* (mean+ sd + N) ,
    data = person_level,
    fmt = fmt_sprintf("%.0f"),
    title = 'Profit Comparison by Demographic Characteristics', 
    note = "This table displays the group-level averages and standard deviations for the person-level average profit",
    output = "huxtable"
)

tbl3_profit
addWorksheet(wb, "Table 3 Profit")
writeData(wb, tbl3_profit, sheet = "Table 3 Profit")
```

```{r}
person_level %>% group_by(y1_status_v2) %>% summarize(profposi = mean(profposi), prof10k = mean(prof10k), n = n())


person_level %>% summarize(profposi = mean(profposi), prof10k = mean(prof10k), n = n())
```



```{r function to log transform vars with negative values in them}
# feed it a vector to convert to log transform that accounts for negative values 
log_transform <- function(x) {
  min_x <- min(x)*-1
  log(x + min_x + 1)
}
```


```{r creating person-year level df }

## getting down to a dataset that has their demographic vars and yearly earnings at the person-year level
temp <- se_sample %>% 
  filter(monthcode %% 12 == 0) %>% 
  select(ssuid_spanel_pnum, 
         y1_status_v2, 
         unemp_f12,
         educ_fct, 
         race_eth_fct_cpsd,
         sex_fct,
         immig_fct,
         parent_std,
         married,
         industry_y1_mode,
         tage,
         calyear,
         prftb, 
         wpfinwgt,
         val,
         profposi,
         prof10k) %>% 
  mutate(unemp_f12_6 = factor(ifelse(unemp_f12 >=6, 1,0), labels = c("Not Unemployed", "Unemployed")),
         unemp_f12_3 = factor(ifelse(unemp_f12 >=3, 1,0), labels = c("Not Unemployed", "Unemployed")))

find_max_mode <- function(x) {
  u <- unique(x)
  tab <- tabulate(match(x, u))
  max(u[tab == max(tab)]) 
}

## here we get their earnings in each calendar year as well as their most common industry in that year
temp_earnings <- se_sample %>% 
  group_by(ssuid_spanel_pnum, calyear) %>% 
  summarize(tpearn_annual= sum(tpearn_inf),
            mode_industry = find_max_mode(industry_fct)) %>% 
  ungroup() %>% 
  mutate(ln_tpearn_annual = log_transform(tpearn_annual))



person_year <- left_join(temp_earnings, temp, by = c("ssuid_spanel_pnum", "calyear")) %>% 
  mutate(industry_experience = case_when(mode_industry == industry_y1_mode ~ 1,
                                         .default = 0))

```


```{r setting variable labels for person_year df}
person_year <- person_year %>%
  mutate(married = factor(married, levels = c(0,1), labels = c( "Not Married", "Married")),
         parent_std = factor(parent_std, levels = c(0,1), labels = c("Not Parent", "Parent")),
         mode_industry = fct_infreq(mode_industry)) %>% 
  set_variable_labels(
    ln_tpearn_annual = "Log earnings (tpearn)",
    sex_fct = "Sex",
    y1_status_v2 = "Initial Status",
    race_eth_fct_cpsd = "Race",
    educ_fct = "Education",
    unemp_f12_6 = "Unemployed 6-months",
    mode_industry = "Industry",
    married = "Marital Status",
    tage = "Age",
    immig_fct = "Nativity",
    calyear = "Year",
    profposi = "Positive Profit",
    prof10k = "Profit >=10k",
    industry_experience = "Prior Industry Experience"
  )
    
```

    
Education, 
industry categories, 
year of survey, 
immigrant status, 
marital status,
parental status
race/eth
sex
industry_experience 
age

## Table 1 Descriptive Table of key variables

```{r}
data_overview <- datasummary(
  tpearn_annual + factor(profposi) + factor(prof10k) + sex_fct + race_eth_fct_cpsd + educ_fct + immig_fct + married + parent_std + tage + factor(calyear) + factor(industry_experience) ~ N + Percent()+ Mean + SD + Median,
  data = person_year,
   fmt = fmt_sprintf("%.0f"),
    title = 'Data Overview Table',
    output = "huxtable"
)

data_overview
addWorksheet(wb, "Data Overview")
writeData(wb, data_overview, sheet = "Data Overview")

  
```

## Correlation Table
```{r}
library(ggcorrplot)

cor_df <- person_year %>% 
  select(tpearn_annual, profposi, prof10k, sex_fct, race_eth_fct_cpsd, educ_fct, immig_fct, married, parent_std, tage, calyear, industry_experience)
cor_matrix <- model.matrix(~0+., data=cor_df) %>% 
  cor() %>% 
  rstatix::pull_lower_triangle()

print(cor_matrix)

addWorksheet(wb, "Correlation Table")
writeData(wb, cor_matrix, sheet = "Correlation Table")

```



# Regressions for earnings
## Earnings Unemployment models 
```{r unemployment earnings models }
person_year <- person_year %>% 
  mutate(age_sq = tage^2) %>% 
  set_variable_labels(age_sq = "Age Squared")


library(plm)
unemp_m1_plm <- plm(ln_tpearn_annual ~ unemp_f12_6  + 
                   educ_fct + 
                   tage + 
                   age_sq + 
                   sex_fct + 
                   immig_fct + 
                   married + 
                   parent_std +
                   calyear + 
                   mode_industry , data = person_year,
                   index = c("ssuid_spanel_pnum", "calyear"), 
                   model = "random")

unemp_m2_plm <- update(unemp_m1_plm, . ~. + race_eth_fct_cpsd)

## Adding in industry experience
unemp_m1_plm_industry <- update(unemp_m1_plm, . ~. + industry_experience)
unemp_m2_plm_industry <- update(unemp_m2_plm, . ~. + industry_experience)

## removing mode_industry 
unemp_m1_plm_exp <- update(unemp_m1_plm,. ~. + industry_experience -mode_industry)
unemp_m2_plm_exp <- update(unemp_m2_plm,.~. + industry_experience - mode_industry)


```


Setting up renaming conventions for subsequent model tables 
```{r}
mapping <- c(
  # Main Variables of Interest
  "unemp_f12_6Unemployed" = "Unemployed 6+",
  "race_eth_fct_cpsdNon_white" = "Non-White",
  "industry_experience" = "Prior Industry Experience: Yes",
  
  # Demographic Variables
  "sex_fctFemale" = "Female",
  "tage" = "Age", 
  "age_sq" = "Age sq",
  "immig_fctImmigrant" = "Immigrant",
  "marriedMarried" = "Married",
  "parent_stdParent" = "Parent",
  
  # Education 
  "educ_fctSome College or Assoc" = "Educ: Some College or Assoc",
  "educ_fct4-year Degree or More" = "Educ: 4-Year Degree +",
  
  # Year Effects
  "calyear2015" = "2015",
  "calyear2016" = "2016",
  "calyear2018" = "2018",
  "calyear2019" = "2019",
  "calyear2020" = "2020",
  "calyear2021" = "2021",
  "calyear2022" = "2022",
  
  # Industry Effects
  "mode_industryConstruction" = "Industry: Construction",
  "mode_industryOther Services, Except Public Administration" = "Industry: Other Services",
  "mode_industryEducational Services, and Health Care and Social Assistance" = "Industry: Educ. & Health",
  "mode_industryFinance and Insurance, and Real Estate, and Rental and Leasing" = "Industry: Finance & Real Estate",
  "mode_industryRetail Trade" = "Industry: Retail Trade",
  "mode_industryArts, Entertainment, and Recreation, and Accommodation and Food Services" = "Industry: Arts & Food Services",
  "mode_industryForestry, Farming, Fishing, Hunting, & Mining" = "Industry: Forestry, Farming, & Mining",
  "mode_industryTransportation, Warehousing & Utilities" = "Industry: Transport. & Utilities",
  "mode_industryManufacturing" = "Industry: Manufacturing",
  "mode_industryWholesale Trade" = "Industry: Wholesale Trade",
  "mode_industryInformation" = "Industry: Information",
  "mode_industryPublic Administration" = "Industry: Public Administration",
  
  "(Intercept)" = "(Intercept)",
  # catch-all 
  "..." = "..." 
  
)
```

Adding reference category rows
```{r}
rows_to_add <- tribble(
  ~term, ~m1, ~m2, ~m3, ~m4, ~m5, ~m6,
  "Employed (Reference)", "", "", "", "", "", "", #1
  "White (Reference)", "", "", "", "", "", "", #3
  "Prior Industry Experience: No (Reference)", "", "", "", "", "", "", #5
  "Male (Reference)", "", "", "", "", "", "", # 7
  "US Born (Reference)", "", "", "", "", "", "", #11
  "Not Married (Reference)", "", "", "", "", "", "", #13
  "Not Parent(Reference)", "", "", "", "", "", "", #15
  "High School or Less (Reference)", "", "", "", "", "", "", # 17
  "Calendar Year: 2014 (Reference)", "", "", "", "", "", "", # 20
  "Professional, Scientific, and Management, and Administrative, and Waste Management Services 
 (Reference)", "", "", "", "", "", "" # 28
)
attr(rows_to_add, 'position') <- c(1, 3, 5, 7, 11, 13, 15, 17, 20,28)
```


```{r}
tbl3_unemp_models_rse <- modelsummary(list(unemp_m1_plm,
                                           unemp_m2_plm, 
                                           unemp_m1_plm_industry, 
                                           unemp_m2_plm_industry,
                                           unemp_m1_plm_exp, 
                                           unemp_m2_plm_exp), 
                                      coef_map = mapping,
                                      add_rows = rows_to_add,
                                      estimate = "{estimate} ({std.error}){stars}",
                                      vcov = "robust",
                                      statistic = NULL,
                                      title = "Table 3 Robust SE Unemployment predicting Log Annual Earnings", 
                                      output = "gt")

tbl3_unemp_models_rse
addWorksheet(wb, "Tbl 3 Reg Unemp Earn RSE")
writeData(wb, tbl3_unemp_models_rse, sheet = "Tbl 3 Reg Unemp Earn RSE")
```




# Profits Unemployment
```{r models for positive profit}
m1_unemp_prftb <- glmer(profposi ~ unemp_f12_6  + 
                   educ_fct + 
                   tage + 
                   age_sq + 
                   sex_fct + 
                   immig_fct + 
                   married + 
                   parent_std +
                   as.factor(calyear) + 
                   mode_industry +
                   (1 | ssuid_spanel_pnum),
                   control = glmerControl(optimizer = "nloptwrap",
                                          calc.derivs = FALSE),
                 data = person_year, family = binomial)


m2_unemp_prftb <- update(m1_unemp_prftb, . ~ .  + race_eth_fct_cpsd)

## adding industry experience
m1_unemp_prftb_ind <- update(m1_unemp_prftb, . ~. + industry_experience)
m2_unemp_prftb_ind <- update(m2_unemp_prftb, . ~. + industry_experience)

## removing mode_industry
m1_unemp_prftb_exp <- update(m1_unemp_prftb, . ~. +industry_experience -mode_industry)
m2_unemp_prftb_exp <- update(m2_unemp_prftb,. ~. + industry_experience - mode_industry)

```





```{r models for 10k profit}
m1_unemp_prftb10 <- glmer(prof10k ~ unemp_f12_6  + 
                   educ_fct + 
                   tage + 
                   age_sq + 
                   sex_fct + 
                   immig_fct + 
                   married + 
                   parent_std +
                   mode_industry +
                   as.factor(calyear) +
                   (1 | ssuid_spanel_pnum),
                   control = glmerControl(optimizer = "nloptwrap",
                                          calc.derivs = FALSE),
                 data = person_year, family = binomial)
m2_unemp_prftb10 <- update(m1_unemp_prftb10, . ~ .  + race_eth_fct_cpsd)

## adding in experience variable 
m1_unemp_prftb10_ind <- update(m1_unemp_prftb10, . ~. + industry_experience)
m2_unemp_prftb10_ind <- update(m2_unemp_prftb10, . ~. + industry_experience)

## just new experience variable 
m1_unemp_prftb10_exp <- update(m1_unemp_prftb10, . ~. + industry_experience -mode_industry)
m2_unemp_prftb10_exp <- update(m2_unemp_prftb10, . ~. + industry_experience - mode_industry)
```


### Table 5 Unemployment and Positive Profit

Need slightly different variable mapping due to how the model types handle the calyear variable. Above plm dummies it out by default. Here we do it manually. 
```{r}
mapping <- c(
  # Main Variables of Interest
  "unemp_f12_6Unemployed" = "Unemployed 6+",
  "race_eth_fct_cpsdNon_white" = "Non-White",
  "industry_experience" = "Prior Industry Experience: Yes",
  
  # Demographic Variables
  "sex_fctFemale" = "Female",
  "tage" = "Age", 
  "age_sq" = "Age sq",
  "immig_fctImmigrant" = "Immigrant",
  "marriedMarried" = "Married",
  "parent_stdParent" = "Parent",
  
  # Education 
  "educ_fctSome College or Assoc" = "Educ: Some College or Assoc",
  "educ_fct4-year Degree or More" = "Educ: 4-Year Degree +",
  
  # Year Effects
  "as.factor(calyear)2015" = "2015",
  "as.factor(calyear)2016" = "2016",
  "as.factor(calyear)2018" = "2018",
  "as.factor(calyear)2019" = "2019",
  "as.factor(calyear)2020" = "2020",
  "as.factor(calyear)2021" = "2021",
  "as.factor(calyear)2022" = "2022",
  
  # Industry Effects
  "mode_industryConstruction" = "Industry: Construction",
  "mode_industryOther Services, Except Public Administration" = "Industry: Other Services",
  "mode_industryEducational Services, and Health Care and Social Assistance" = "Industry: Educ. & Health",
  "mode_industryFinance and Insurance, and Real Estate, and Rental and Leasing" = "Industry: Finance & Real Estate",
  "mode_industryRetail Trade" = "Industry: Retail Trade",
  "mode_industryArts, Entertainment, and Recreation, and Accommodation and Food Services" = "Industry: Arts & Food Services",
  "mode_industryForestry, Farming, Fishing, Hunting, & Mining" = "Industry: Forestry, Farming, & Mining",
  "mode_industryTransportation, Warehousing & Utilities" = "Industry: Transport. & Utilities",
  "mode_industryManufacturing" = "Industry: Manufacturing",
  "mode_industryWholesale Trade" = "Industry: Wholesale Trade",
  "mode_industryInformation" = "Industry: Information",
  "mode_industryPublic Administration" = "Industry: Public Administration",
  
  "(Intercept)" = "(Intercept)",
  # catch-all 
  "..." = "..." 
  
)
```

```{r}


tbl5_unemp_posprof <- modelsummary(list(m1_unemp_prftb,
                   m2_unemp_prftb,
                   m1_unemp_prftb_ind,
                   m2_unemp_prftb_ind,
                   m1_unemp_prftb_exp,
                   m2_unemp_prftb_exp),
                                      coef_map = mapping,
                   add_rows = rows_to_add,
                                  estimate = "{estimate} ({std.error}){stars}",
                           statistic = NULL,
                           title = "Table 5 Unemp Predicting Positive Profit",
             output = "gt")

tbl5_unemp_posprof

addWorksheet(wb, "Tbl 5 Reg Unemp Profit")
writeData(wb, tbl5_unemp_posprof, sheet = "Tbl 5 Reg Unemp Profit")

```

### Table 6 Unemployment and 10k Profit 

```{r}
tbl6_unemp_prof10k <- modelsummary(list(m1_unemp_prftb10,
                   m2_unemp_prftb10,
                   m1_unemp_prftb10_ind,
                   m2_unemp_prftb10_ind,
                   m1_unemp_prftb10_exp,
                   m2_unemp_prftb10_exp
              ),
                                      coef_map = mapping,
              add_rows = rows_to_add,
                                  estimate = "{estimate} ({std.error}){stars}",
                           statistic = NULL,
                           title = "Table 6 Unemp Predicting 10k Profit",
             output = "gt")

tbl6_unemp_prof10k
addWorksheet(wb, "Tbl 6 Reg Unemp 10k Profit")
writeData(wb, tbl6_unemp_prof10k, sheet = "Tbl 6 Reg Unemp 10k Profit")

```


```{r}
saveWorkbook(wb, "working_paper_outputs_20250731.xlsx", overwrite = TRUE)
```




