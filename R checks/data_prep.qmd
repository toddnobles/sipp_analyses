---
title: "data_prep"
format: html
---
 
 
This is the second script in the process for recreating the Stata anaylses for the SIPP data. This script reads in the raw SIPP files, extracts relevant work/income variables, reshapes the person-month-job variables to align to the person-month variables. 

```{r}
library(tidyverse)
library(bit64)
```


```{r}
monthly <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/sipp_monthly_combined.rds")
joblevel_wide <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/sipp_joblevel_combined_wide.rds") 

# pu2014w1_joblevel  <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2014w1_joblevel.rds")
# pu2014w2_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2014w2_joblevel.rds")
# pu2014w3_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2014w3_joblevel.rds")
# pu2014w4_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2014w4_joblevel.rds")
# pu2018_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2018_joblevel.rds")
# pu2019_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2019_joblevel.rds")
# pu2020_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2020_joblevel.rds")
# pu2021_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2021_joblevel.rds")
# pu2022_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2022_joblevel.rds")
# pu2023_joblevel <- readRDS("/Volumes/ExtremeSSD/SIPP Data Files/rds/pu2023_joblevel.rds")
```


```{r}
monthly <- monthly %>% mutate(
  ssuid = as.character.integer64(ssuid),
  ssuid_spanel_pnum = paste0(
        ssuid,
        as.character(spanel),
        as.character(pnum)
      ))


joblevel_wide <- joblevel_wide %>% mutate(
  ssuid = as.character.integer64(ssuid),
  ssuid_spanel_pnum = paste0(
        ssuid,
        as.character(spanel),
        as.character(pnum)
      )
)
```

Here we impute those instances where someone had all of the earnings and job information we care about but did not have a jobid value for that specific job. Because we conduct later analyses at the month level we don't particularly care if this job is just an uncoded version of ejobid 101 , 102, 103 for instance. Put differently, it's unclear from the data quality flags why these are "not in universe" for jobid, but the records contain all the information we'd want so we can impute some fictional jobids. We lose the ability to track if these are the same jobs they held before/after that month but we aren't concerned with that. 

```{r}
joblevel_wide %>% filter(ssuid == "418209316" & pnum == 102) %>% select(ssuid_spanel_pnum, ssuid, pnum, monthcode, contains("enjflag"), contains("jborse"), contains("jobid"), contains("msum"), contains("prftb"), contains("mwkhrs"), contains("ind")) 
```

```{r}
joblevel_wide <- joblevel_wide %>% 
  select(
      'ssuid',
      'spanel',
      'swave',
      'pnum',
      'monthcode',
      'ssuid_spanel_pnum',
      contains("prftb"),
      contains("msum"),
      contains("mwkhrs"),
      contains("jborse"),
      contains("jobid"),
      contains("ind"),
      contains("tbsj")) %>%
    tidylog::mutate(
      ejb1_jobid = ifelse(
        is.na(ejb1_jobid) & !is.na(tjb1_mwkhrs) & !is.na(ejb1_jborse) &
          (!is.na(tjb1_msum) | !is.na(tjb1_prftb)),
        1,
        ejb1_jobid
      ),
      ejb2_jobid = ifelse(
        is.na(ejb2_jobid) & !is.na(tjb2_mwkhrs) & !is.na(ejb2_jborse) &
          (!is.na(tjb2_msum) |
             !is.na(tjb2_prftb)),
        2,
        ejb2_jobid
      ),
      ejb3_jobid = ifelse(
        is.na(ejb3_jobid) & !is.na(tjb3_mwkhrs) & !is.na(ejb3_jborse) &
          (!is.na(tjb3_msum) |
             !is.na(tjb3_prftb)),
        3,
        ejb3_jobid
      ),
      ejb4_jobid = ifelse(
        is.na(ejb4_jobid) & !is.na(tjb4_mwkhrs) & !is.na(ejb4_jborse) &
          (!is.na(tjb4_msum) |
             !is.na(tjb4_prftb)),
        4,
        ejb4_jobid
      ),
      ejb5_jobid = ifelse(
        is.na(ejb5_jobid) & !is.na(tjb5_mwkhrs) & !is.na(ejb5_jborse) &
          (!is.na(tjb5_msum) |
             !is.na(tjb5_prftb)),
        5,
        ejb5_jobid
      ),
      ejb6_jobid = ifelse(
        is.na(ejb6_jobid) & !is.na(tjb6_mwkhrs) & !is.na(ejb6_jborse) &
          (!is.na(tjb6_msum) |
             !is.na(tjb6_prftb)),
        6,
        ejb6_jobid
      ),
      ejb7_jobid = ifelse(
        is.na(ejb7_jobid) & !is.na(tjb7_mwkhrs) & !is.na(ejb7_jborse) &
          (!is.na(tjb7_msum) |
             !is.na(tjb7_prftb)),
        7,
        ejb7_jobid
      )
    )

```


```{r combining to one dataframe}
full_data_base <- tidylog::left_join(monthly, joblevel_wide, by = c("ssuid_spanel_pnum", "spanel", "swave", "monthcode"))
```

```{r filtering to working age pop by age at entry}
full_data <- full_data_base %>% 
  group_by(ssuid_spanel_pnum) %>% 
  mutate(age_entry = min(tage),
         age_exit = max(tage)) %>% 
  filter(age_entry >= 18 & age_entry <= 64) %>% ungroup()
```


```{r standardizing enjflag}
# Unemployment flag is 0 = not unemployed and 1 = unemployed for 2014 panel. Then switches to 2 = not unemployed and 1 = unemployed for 2018 onwards. So recoding accordingly here 
full_data <- full_data %>% 
  mutate(enjflag_std = ifelse(spanel == 2014 & enjflag == 1, 1,
                              ifelse(spanel >2014 & enjflag == 1, 1,
                                     ifelse(enjflag == 0 | enjflag == 2, 0, NA)))) 
```


Dropping those who never worked
```{r}
full_data <- full_data %>% 
  mutate(workless_month = if_all(starts_with("ejb") & ends_with("jobid"), is.na)) %>% 
  mutate(workless_month = ifelse(workless_month, 1, 0)) %>% 
  group_by(ssuid_spanel_pnum) %>% 
  mutate(months_in_data = n(),
         workless_month_tot = sum(workless_month)) %>%
  ungroup() %>% 
  tidylog::filter(months_in_data > workless_month_tot) 

```



Now we need to mark their main job based on number of hours worked and keep only that row for the month. 
```{r}
full_data <- full_data %>% 
  tidylog::select(-ends_with(".y"), -starts_with("ajb")) %>% 
  rename_with(
    ~ gsub("^(tbsj\\d+)(val)$", "\\1_\\2", .), # adding in underscore to match the name formatting of tjb and ejb variables for easier reshaping
    starts_with("tbsj")
  ) 
```


```{r}
ptm <- proc.time()

long <- full_data %>% 
  #head(1000000) %>% 
  pivot_longer(
    cols = matches("^(tjb|ejb|tbsj)\\d+_"),  
    names_to = c("job", ".value"),     
    names_pattern = "^[a-z]+(\\d+)_(.*)$" 
  ) %>% group_by(ssuid_spanel_pnum, swave, monthcode) %>% 
  relocate(ssuid_spanel_pnum, swave, monthcode, jobid, mwkhrs, msum) %>% 
  slice_max(mwkhrs, with_ties = FALSE) %>% ungroup()
proc.time() - ptm
```



```{r}
long2 <- full_data %>% 
  head(2000) %>% 
  pivot_longer(
    cols = matches("^(tjb|ejb|tbsj)\\d+_"),  
    names_to = c("job", ".value"),     
    names_pattern = "^[a-z]+(\\d+)_(.*)$" 
  ) %>% group_by(ssuid_spanel_pnum, swave, monthcode) %>% 
  relocate(ssuid_spanel_pnum, swave, monthcode, jobid, mwkhrs, msum) %>% 
  slice_max(msum, with_ties = FALSE) %>% ungroup()
```


```{r}
long_wd <- long %>% 
  mutate(employment_type = case_when(jborse ==1 ~  1,
                                     jborse == 2 ~ 2,
                                     jborse == 3 ~ 3,
                                     is.na(jborse) & enjflag_std == 1 ~ 4,
                                     .default = NA)) %>%  # this creates ~300 NAs, where they have no job data for their main job but they don't get flagged as unemployed spell in the enjflag data. So we'll impute unemployment here for these months. 
  tidylog::mutate(employment_type = ifelse(is.na(employment_type), 4, employment_type)) %>% 
  tidylog::mutate(hispanic = case_when(eorigin == 1 ~ 1,
                                      eorigin == 2 ~ 0,
                                      .default= NA)) 


```
Investigating inconsistent race and ethnicity values for individuals. For example, 378 people changed their response to whether or not they were hispanic during the course of their survey participation. Likewise, 1747 people changed their response to their race question during the course of the survey. 
```{r}
temp <- long_wd %>% group_by(ssuid_spanel_pnum) %>% 
  mutate(erace_change = erace != first(erace, default= first(erace)),
         hispanic_change = hispanic !=first(hispanic, default = first(hispanic))) %>% 
  ungroup() %>% relocate(ssuid_spanel_pnum,  erace_change, erace, hispanic, hispanic_change) 

temp %>% group_by(hispanic_change) %>% distinct(ssuid_spanel_pnum) %>% count()
temp %>% group_by(erace_change) %>% distinct(ssuid_spanel_pnum) %>% count()
```

# recoding demographic variables    
```{r}
long_wd <- long_wd %>% 
  arrange(ssuid_spanel_pnum, swave, monthcode) %>% 
  group_by(ssuid_spanel_pnum) %>% 
  mutate(erace_std = first(erace),
         hispanic_std = first(hispanic)) %>% 
  ungroup() %>% 
  mutate(race_eth = case_when(hispanic_std == 1 ~ "Hispanic",
                              erace_std == 1 ~ "White", 
                              erace_std == 2 ~ "Black", 
                              erace_std == 3 ~ "Asian",
                              erace_std == 4 ~ "Other",
                              .default = NA),
         race_eth_fct = factor(race_eth, levels = c("White", "Black", "Hispanic", "Asian", "Other")),
         sex_fct = factor(esex, levels = c(1,2), labels = c("Male", "Female")),
         immig_fct = factor(ebornus, levels = c(1,2), labels = c("US Born", "Immigrant")),
         calyear = case_when(spanel == 2014 & swave == 1 ~ 2013, # https://www2.census.gov/programs-surveys/sipp/2023/2023_SIPP_Data_Overview_Handout_SEP23.pdf
                             spanel == 2014 & swave == 2 ~ 2014,
                             spanel == 2014 & swave == 3 ~ 2015, 
                             spanel == 2014 & swave == 4 ~ 2016, 
                             
                             spanel == 2018 & swave == 1 ~ 2017,
                             spanel == 2018 & swave == 2 ~ 2018,
                             spanel == 2018 & swave == 3 ~ 2019, 
                             spanel == 2018 & swave == 4 ~ 2020, 
                             
                             spanel == 2019 & swave == 1 ~ 2018,
                             
                             spanel == 2020 & swave == 1 ~ 2019,
                             spanel == 2020 & swave == 2 ~ 2020,
                             spanel == 2020 & swave == 3 ~ 2021, 
                             spanel == 2020 & swave == 4 ~ 2022,
                             
                             spanel == 2021 & swave == 1 ~ 2020,
                             spanel == 2021 & swave == 2 ~ 2021,
                             spanel == 2021 & swave == 3 ~ 2022,
                             
                             spanel == 2022 & swave == 1 ~ 2021,
                             spanel == 2022 & swave == 2 ~ 2022,
                             
                             spanel == 2023 & swave == 1 ~ 2022,
                             .default = NA),
         educ_fct = factor(case_when(eeduc >= 43 ~ "4-year Degree or More",
                              eeduc >= 40 ~ "Some College or Assoc",
                              eeduc < 40 ~ "HS or Less", 
                              .default = NA), levels = c("HS or Less", "Some College or Assoc", "4-year Degree or More")),
         industry_fct = case_when(ind < 570 ~ "Forestry, Farming, Fishing, Hunting, & Mining",
                                  ind == 770 ~ "Construction",
                                  ind >=1070 & ind <=3990 ~ "Manufacturing",
                                  ind >= 4070 & ind <= 4590 ~ "Wholesale Trade",
                                  ind >= 4670 & ind <= 5790 ~ "Retail Trade",
                                  (ind >=6070 & ind <= 6390) | (ind >= 570 & ind <= 690) ~ "Transportation, Warehousing & Utilities",
                                  ind >= 6470 & ind <= 6780 ~ "Information",
                                  ind >= 6870 & ind <= 7190 ~ "Finance and Insurance, and Real Estate, and Rental and Leasing",
                                  ind >= 7270 & ind <= 7790 ~ "Professional, Scientific, and Management, and Administrative, and Waste Management Services",
                                  ind >= 7860 & ind <= 8470  ~ "Educational Services, and Health Care and Social Assistance",
                                  ind >= 8560 & ind <= 8690 ~ "Arts, Entertainment, and Recreation, and Accommodation and Food Services",
                                  ind >= 8770 & ind <= 9290 ~ "Other Services, Except Public Administration",
                                  ind >= 9370 & ind <= 9590  ~ "Public Administration",
                                  ind >= 9890  ~ "Military",
                                  .default = NA)
  )
```



```{r}
temp <- long_wd %>% 
  mutate(parent = ifelse(tceb >0, 1,
                         ifelse(tceb == 0, 0, NA))) %>% 
  arrange(ssuid_spanel_pnum, swave, monthcode) %>%  
  group_by(ssuid_spanel_pnum) %>% 
  mutate(parent_disappear = parent < first(parent)) %>% ungroup()
```

To-dos: 
- recode parent
  - impute missings where someone was a parent early on and then no longer reported being a parent, we can do this since the question is phrased as ever having had a child. 
- flag for unemployment during first 12 months
- most common status during first 12 months
- quantifying self-employment after the first 12 months
- drop military industry 
- drop other employment people
- drop missings



- look at annual earnings 
