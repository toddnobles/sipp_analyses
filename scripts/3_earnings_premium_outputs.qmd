---
title: "3_earnings_premium_outputs"
format: docx
author: "Todd Nobles"
date: Sys.Date()
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lqmm)
library(lme4)
library(kableExtra)
library(haven)
library(tidyverse)
options(scipen = 9)
```

Reading in the data exported by 2_earnings_premium_data_prep.qmd. Here this is the cleaned data that removes those with incoherent earnings/work hour combination pairs. We've filtered to those who were W&S after year 1. This is a person-month level file. 

```{r}
df2 <- readRDS("/Users/toddnobles/Documents/sipp_analyses/R checks/ws_sample_cleanest.rds")
```


```{r}
earnings <- df2 %>% 
  # dropping those who started as unemp.
  filter(y1_status_v2 != 4) %>% 
  mutate(y1_status_v2_fct = factor(y1_status_v2, labels = c("remainedW&S", "formerlySE")),
         mari_status_collapsed = case_when(
           ems == 1 | ems == 2 ~ "Married", 
           # second category here is spouse, absent may want to group with the second level here, but we'll see 
           ems == 3 | ems == 4 | ems == 5 ~ "Divorced/Separated/Widowed",
           ems == 6 ~ "Never married",
           TRUE ~ NA_character_  
         ),
         mari_status_collapsed = factor(
           mari_status_collapsed,
           levels = c("Married", "Divorced/Separated/Widowed", "Never married")
         ),
         age = tage, 
         age2 = tage^2,
         parent_fct = factor(parent_std, labels = c( "Not a parent","Parent"))
  )

earnings <- earnings %>% 
  group_by(ssuid_spanel_pnum) %>%
  tidylog::filter(!any(is.na(mari_status_collapsed))) %>% 
  ungroup()
```


```{r}
# feed it a vector to convert to log transform that accounts for negative values 
log_transform <- function(x) {
  min_x <- min(x)*-1
  log(x + min_x + 1)
}
```



## Person-level Statistics
```{r}
person_level <- earnings %>%
  arrange(ssuid_spanel_pnum, swave, monthcode) %>% 
  # getting to person-year level
  group_by(ssuid_spanel_pnum, calyear) %>%
  summarize(# the following three are all constant within individuals so we just grab their first value
    y1_status_v2_fct = first(y1_status_v2_fct),
    race_eth_fct_cpsd = first(race_eth_fct_cpsd),
    sex_fct = first(sex_fct),
    # here we take their highest education value ever observed 
    educ_fct = last(educ_fct),
    tpearn_annual = sum(tpearn),
    industry = first(industry_fct),
    msum_annual = sum(msum)) %>% 
  # summarizing to person-level 
  group_by(ssuid_spanel_pnum) %>% 
  summarize(
    avg_tpearn = mean(tpearn_annual),
    y1_status_v2_fct = first(y1_status_v2_fct),
    race_eth_fct_cpsd = first(race_eth_fct_cpsd),
    sex_fct = first(sex_fct),
    # here we take their highest education value ever observed 
    educ_fct = last(educ_fct),
    industry = first(industry),
    avg_msum = mean(msum_annual),
  ) %>%
  ungroup()

```


```{r, setting labels for person-level file}
#| message: false
library(labelled)
person_level <- person_level %>%
  set_variable_labels(
    avg_tpearn = "Avg earnings (tpearn)",
    sex_fct = "Sex",
    y1_status_v2_fct = "Initial Status",
    race_eth_fct_cpsd = "Race/Ethnicity",
    educ_fct = "Education",
    industry = "Industry",
    avg_msum = "Avg earnings (msum)")
```



### Table 1 Sample Overview
```{r}
library(gtsummary)

tbl1 <- person_level %>%
  select(avg_tpearn, avg_msum, race_eth_fct_cpsd, y1_status_v2_fct, educ_fct, sex_fct, industry) %>% 
  tbl_summary(by = y1_status_v2_fct,
             statistic = list(
    all_continuous() ~ c("{mean} ({sd})", "{median}")
  ),
  type = all_continuous() ~ "continuous2"
) %>% 
  add_overall()

tbl1 
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "Table 1 Sample Overview")
writeData(wb, tbl1 , sheet = "Table 1 Sample Overview")
```


### Table 2 Summary Statistics for earnings by demographic characteristics
```{r}
#| message: false
library(modelsummary)

tbl2 <- datasummary(
  (` `= avg_tpearn * (Sex = sex_fct)) +
     (` `= avg_tpearn * (Race = race_eth_fct_cpsd)) +
    (` ` = avg_tpearn * (Education =educ_fct))~ y1_status_v2_fct*( N+ Mean+ Median + 
                                                                     P25 + P75 + SD),
    data = person_level,
    fmt = fmt_sprintf("%.0f"),
    title = 'Earnings (tpearn) Comparison by Demographic Characteristics', 
    note = "This table displays the group-level averages and standard deviations for the person-level average earnings.",
    output = "gt"
)

tbl2 
addWorksheet(wb, "Table 2 Person_level Tpearn")
writeData(wb, tbl2, sheet = "Table 2 Person_level Tpearn")
```



```{r}
# cmp_psn_lvl_race <- person_level_avg  %>% 
#   group_by(y1_status_v2_fct, race_collapsed_fct) %>% 
#   summarize(people = n_distinct(ssuid_spanel_pnum_id),
#             mean = mean(avg_earnings),
#             mean_ln = mean(avg_earnings_ln),
#             p25 = quantile(avg_earnings,.25), 
#             p50 = quantile(avg_earnings,.5), 
#             p75 = quantile(avg_earnings,.75))

```

```{r}
# library(openxlsx)
# # Create a new Excel workbook
# wb <- createWorkbook()
# 
# # Add each table to a separate sheet
# addWorksheet(wb, "Education")
# writeData(wb, "Education", cmp_psn_lvl_education)
# 
# addWorksheet(wb, "Race")
# writeData(wb, "Race", cmp_psn_lvl_race)
# 
# addWorksheet(wb, "Sex")
# writeData(wb, "Sex", cmp_psn_lvl_sex)
# 
# 
# 
# # Save the workbook
# saveWorkbook(wb, "summary_tables.xlsx", overwrite = TRUE)
```





## Person-Year level Statistics
```{r creating person-year level df }



## getting down to a dataset that has their demographic vars and yearly earnings at the person-year level
temp <- earnings %>% 
  filter(monthcode %% 12 == 0) %>% 
  select(ssuid_spanel_pnum, 
         y1_status_v2_fct, 
         educ_fct, 
         race_eth_fct_cpsd,
         sex_fct,
         immig_fct,
         industry_fct,
         age, 
         age2,
         mari_status_collapsed,
         parent_fct, 
         calyear) %>% 
  mutate(calyear_fct = factor(calyear))


temp_earnings <- earnings %>% 
  group_by(ssuid_spanel_pnum, calyear) %>% 
  summarize(tpearn_annual= sum(tpearn),
            msum_annual = sum(msum)) %>% 
  ungroup()


person_year <- left_join(temp_earnings, temp, by = c("ssuid_spanel_pnum", "calyear")) %>% 
    mutate(ln_tpearn_annual = log_transform(tpearn_annual),
           ln_msum_annual = log_transform(msum_annual)) 

```


```{r setting variable labels for person_year df}
person_year <- person_year %>%
  set_variable_labels(
    ln_tpearn_annual = "Log earnings (tpearn)",
    ln_msum_annual = "Log earnings (msum)",
    tpearn_annual = "Earnings (tpearn)",
    msum_annual = "Earnings (msum)",
    sex_fct = "Sex",
    y1_status_v2_fct = "Initial Status",
    race_eth_fct_cpsd = "Race",
    educ_fct = "Education",
    industry_fct = "Industry",
    age = "Age",
    age2 = "Age Squared",
    immig_fct = "Nativity",
    calyear_fct = "Year"
    
  )
    
```


### Table 3 Summary Statistics for earnings by demographic characteristics

```{r}
tbl3 <- datasummary(
  (` `= tpearn_annual * (Sex = sex_fct)) +
     (` `= tpearn_annual * (Race = race_eth_fct_cpsd)) +
    (` ` = tpearn_annual * (Education =educ_fct))~ y1_status_v2_fct*( N+ Mean+ Median + 
                                                                     P25 + P75 + SD),
    data = person_year,
    fmt = fmt_sprintf("%.0f"),
    title = 'Earnings (tpearn) Comparison by Demographic Characteristics (Person-year level data)', 
    note = "This table displays the group-level averages and standard deviations for the person-year level average earnings.",
    output = "gt"
)

tbl3 
addWorksheet(wb, "Table 3 Person_year Tpearn")
writeData(wb, tbl3, sheet = "Table 3 Person_year Tpearn")
```

```{r}
saveWorkbook(wb, paste0("/Users/toddnobles/Documents/sipp_analyses/outputs/earnings_premium_descriptives",Sys.Date(),".xlsx"), overwrite = TRUE)

```

Bivariate Model 
```{r}
m1 <- lqmm(fixed = ln_tpearn_annual ~ y1_status_v2_fct, 
                       random = ~1, 
                               group = + ssuid_spanel_pnum, 
                               tau = c( 0.25, 0.5, .75),
                               data = person_year,
                               control = lqmmControl(method = "df"))
```




```{r}
m2<- lqmm(fixed = ln_tpearn_annual ~ y1_status_v2_fct + 
            sex_fct + 
            race_eth_fct_cpsd + calyear_fct , 
                       random = ~1, 
                               group = + ssuid_spanel_pnum, 
                               tau = c( 0.25, 0.5, .75),
                               data = person_year,
                               control = lqmmControl(method = "df"))
```


Adding in age, calyear, immigrant status and industry

```{r}
m3 <- lqmm(
  fixed = ln_tpearn_annual ~ y1_status_v2_fct + 
    sex_fct + 
    race_eth_fct_cpsd +
    educ_fct +
    age + 
    age2 +
    immig_fct +  
    calyear_fct +
    parent_fct +
    mari_status_collapsed + 
    industry_fct,
  ,random = ~ 1,
  group = + ssuid_spanel_pnum,
  tau = c(0.25, 0.5, .75),
  data = person_year,
  control = lqmmControl(method = "df")
)
```

Adding interactions
```{r}
m4 <- lqmm(
  fixed = ln_tpearn_annual ~ y1_status_v2_fct*sex_fct + 
    race_eth_fct_cpsd +
    educ_fct +
    age + 
    age2 +
    immig_fct +  
    calyear_fct +
    parent_fct +
    mari_status_collapsed + 
    industry_fct,
  ,random = ~ 1,
  group = + ssuid_spanel_pnum,
  tau = c(0.25, 0.5, .75),
  data = person_year,
  control = lqmmControl(method = "df")
)


m5 <- lqmm(
  fixed = ln_tpearn_annual ~ y1_status_v2_fct*race_eth_fct_cpsd + 
    sex_fct + 
    educ_fct +
    age + 
    age2 +
    immig_fct +  
    calyear_fct +
    parent_fct +
    mari_status_collapsed + 
    industry_fct,
  ,random = ~ 1,
  group = + ssuid_spanel_pnum,
  tau = c(0.25, 0.5, .75),
  data = person_year,
  control = lqmmControl(method = "df")
)
```



```{r}
summary_m1 <- summary(m1)
summary_m2 <- summary(m2)
summary_m3 <- summary(m3)
summary_m4 <- summary(m4)
summary_m5 <- summary(m5)
```


```{r}

# Function to convert p-values to stars
pval_to_stars <- function(p) {
  if (p < 0.001) "***"
  else if (p < 0.01) "**"
  else if (p < 0.05) "*"
  else if (p < 0.1) "."
  else ""
}

# Function to format model results. Have to feed it in the ttab from each model 

m1_table <- summary_m1$tTable
m2_table <- summary_m2$tTable
m3_table <- summary_m3$tTable
m4_table <- summary_m4$tTable
m5_table <- summary_m5$tTable

format_model_results <- function(model_results, model_name) {
  coefficients_pvalues <- lapply(names(model_results), function(q) {
    data <- model_results[[q]]
    stars <- sapply(data[, "Pr(>|t|)"], pval_to_stars)
    data.frame(
      Term = rownames(data),
      Quantile = q,
      Coefficient = sprintf("%.4f%s", data[, "Value"], stars)
    )
  })
  result <- do.call(rbind, coefficients_pvalues)
  result$Model <- model_name
  return(result)
}

# Format results for both models
result_model1 <- format_model_results(m1_table, "Model 1")
result_model2 <- format_model_results(m2_table, "Model 2")
result_model3 <- format_model_results(m3_table, "Model 3")
result_model4 <- format_model_results(m4_table, "Model 4")
result_model5 <- format_model_results(m5_table, "Model 5")

# Combine results from both models
combined_results <- rbind(result_model1, result_model2, result_model3, result_model4, result_model5)

# Reshape the data to the desired wide format
library(tidyr)
formatted_combined_result <- pivot_wider(combined_results, 
                                         names_from = c(Quantile, Model), 
                                         values_from = Coefficient)

# View the formatted combined result
print(formatted_combined_result)


```




```{r}
library(writexl)
write_xlsx(formatted_combined_result, "combined_model_results2.xlsx")
```


