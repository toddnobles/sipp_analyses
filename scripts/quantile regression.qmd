---
title: "quantile regressions"
format:
  pdf:
    toc: true
    toc-depth: 3
execute:
  echo: false
  message: false
  warning: false
---

-   Article where this method is introduced: <https://link-springer-com.offcampus.lib.washington.edu/article/10.1007/s11222-013-9381-9>
-   R package created by Geraci and accompanying JOSS paper <https://www.jstatsoft.org/article/view/v057i13>
-   Someone's MA thesis that walks through the math behind these in a slightly more accessible way. <https://tigerprints.clemson.edu/cgi/viewcontent.cgi?article=4454&context=all_theses>

```{r}
#| echo: false
#| include: false


library(tidyverse)
library(haven)
library(lqmm)
library(lme4)
library(kableExtra)

earnings <- read_dta("/Users/toddnobles/Documents/sipp_analyses/earnings_models.dta")
earnings <- earnings %>%
  mutate(across(c(sex, immigrant, combine_race_eth, unempf12_6,      
                  pct_se_after_12, mode_status_f12v2, educ3, 
                  industry2, parent), 
                as_factor, 
                .names = "{col}_fct"),
         ssuid_spanel_pnum_id = factor(ssuid_spanel_pnum_id)) 


earnings_multi_obs <- earnings %>% 
  add_count(ssuid_spanel_pnum_id) %>% 
  filter(n < 2)
```

```{r}
#| include: false

data("Orthodont")
Orthodont <- Orthodont %>% 
  mutate(age.c = age -11)

Orthodont2 <- Orthodont %>% 
  mutate(age.c = age - mean(age))

summary(fit.lmer <- lmer(distance ~ age + (1 | Subject), data = Orthodont)) ## 

```

```{r}
#| eval: false
#| include: false
y = Orthodont$distance
x = cbind(1, Orthodont$age)
groups = Orthodont$Subject
z = cbind(1, Orthodont$Subject )

library(qrLMM)
model = QRLMM(y, x, z, groups = groups, MaxIter = 100)


y = earnings$ln_tpearn
x = cbind(1, earnings$unempf12_6_fct)
groups = earnings$ssuid_spanel_pnum_id
z = cbind(1, earnings$ssuid_spanel_pnum_id )

model = QRLMM(y, x, z, groups = groups, p = c(.5),MaxIter = 100)
```

```{r}
#| include: false
summary(fit.lqmm <- lqmm(fixed = distance ~
                           age + Sex, 
                         random = ~1, 
                         group = + Subject, 
                         data = Orthodont))
```

```{r}
#| include: false
#| eval: false  
sample_ids = sample(unique(earnigns$ssuid_spanel_pnum_id), 
                           round(.25 * length(unique(earnigns$ssuid_spanel_pnum_id))))

test_data <- earnings %>% 
  filter(ssuid_spanel_pnum_id %in% sample_ids)
```

```{r Full Sample ln_tpearn ~ unemployment}
#| message: false

unemp_earnings <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct, 
                       random = ~1, 
                               group = + ssuid_spanel_pnum_id, 
                               tau = c(.1, 0.25, 0.5, .75, .9),
                               data = earnings,
                               control = lqmmControl(method = "df"))

unemp_earnings2 <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct  + industry2_fct + factor(calyear), 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = earnings,
                        control = lqmmControl( method = "df"))

unemp_earnings3 <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct  + industry2_fct + factor(calyear) + combine_race_eth_fct, 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = earnings,
                         control = lqmmControl(method = "df"))


```

```{r Full Sample ln_tpearn ~ initial status}
#| message: false

status_earnings <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct, random = ~1, 
                               group = + ssuid_spanel_pnum_id, 
                               tau = c(.1, 0.25, 0.5, .75, .9),
                               data = earnings,
                               control = lqmmControl(method = "df"))

status_earnings2 <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear), 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = earnings,
                         control = lqmmControl(method = "df"))

status_earnings3 <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear) + combine_race_eth_fct, 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = earnings,
                         control = lqmmControl(method = "df"))
```

```{r Self-employed ln_tpearn ~ unemployment}
#| message: false

unemp_earnings_se <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct, random = ~1, 
                               group = + ssuid_spanel_pnum_id, 
                               tau = c(.1, 0.25, 0.5, .75, .9),
                               data = subset(earnings, pct_se_after_12 ==1),
                               control = lqmmControl(method = "df"))

unemp_earnings2_se <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear), 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_se_after_12 ==1 ),
                         control = lqmmControl(method = "df"))

unemp_earnings3_se <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear) + combine_race_eth_fct, 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_se_after_12 ==1 ),
                         control = lqmmControl(method = "df"))
```

```{r Self-employed ln_tpearn ~ initial status}
#| message: false

status_earnings_se <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct, random = ~1, 
                               group = + ssuid_spanel_pnum_id, 
                               tau = c(.1, 0.25, 0.5, .75, .9),
                               data = subset(earnings, pct_se_after_12 ==1),
                               control = lqmmControl(method = "df"))

status_earnings2_se <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear), 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_se_after_12 ==1 ),
                         control = lqmmControl(method = "df"))

status_earnings3_se <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear) + combine_race_eth_fct, 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_se_after_12 ==1 ),
                         control = lqmmControl(method = "df"))
```

```{r Salaried ln_tpearn ~ unemployment}
#| message: false

unemp_earnings_ws <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct, random = ~1, 
                               group = + ssuid_spanel_pnum_id, 
                               tau = c(.1, 0.25, 0.5, .75, .9),
                               data = subset(earnings, pct_ws_after_12 ==1),
                               control = lqmmControl(method = "df"))

unemp_earnings2_ws <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear), 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_ws_after_12 ==1 ),
                         control = lqmmControl(method = "df"))

unemp_earnings3_ws <- lqmm(fixed = ln_tpearn ~ unempf12_6_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear) + combine_race_eth_fct, 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_ws_after_12 ==1 ),
                         control = lqmmControl(method = "df"))
```

```{r Salaried ln_tpearn ~ initial status}
status_earnings_ws <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct, random = ~1, 
                               group = + ssuid_spanel_pnum_id, 
                               tau = c(.1, 0.25, 0.5, .75, .9),
                               data = subset(earnings, pct_ws_after_12 ==1),
                               control = lqmmControl(method = "df"))

status_earnings2_ws <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear), 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_ws_after_12 ==1 ),
                         control = lqmmControl(method = "df"))

status_earnings3_ws <- lqmm(fixed = ln_tpearn ~ mode_status_f12v2_fct + educ3_fct +
                          sex_fct + age + age2 + immigrant_fct + 
                          parent_fct + industry2_fct + factor(calyear) + combine_race_eth_fct, 
                         random = ~1, 
                         group = + ssuid_spanel_pnum_id, 
                         tau = c(.1, 0.25, 0.5, .75, .9),
                         data = subset(earnings, pct_ws_after_12 ==1 ),
                         control = lqmmControl(method = "df"))
```

# Table 7 Relationship between Unemployment and Log Annual Earnings (quantile regression)

## Full Sample

-   base = just unemployment,
-   m2 = + other coefs
-   m3 = other coefs + race"

```{r}
data.frame(pctile = c(.1, .25, .5, .75, .9), 
           base_model = coef(unemp_earnings)["unempf12_6_fct1",],
           model2 = coef(unemp_earnings2)["unempf12_6_fct1",],
           model3 = coef(unemp_earnings3)["unempf12_6_fct1",]) %>% 
  knitr::kable(caption = "Full Sample Extracted Coefficients for Unemployment") %>% 
  kable_styling(latex_options = "scale_down")


```

## Self-employed Sample

This here throws some convergence warnings (I believe due to the smaller sample size for this group. Need to look into further)

```{r}
#| message: false
data.frame(pctile = c(.1, .25, .5, .75, .9), 
           base_model = coef(unemp_earnings_se)["unempf12_6_fct1",],
           model2 = coef(unemp_earnings2_se)["unempf12_6_fct1",],
           model3 = coef(unemp_earnings3_se)["unempf12_6_fct1",]) %>% 
  knitr::kable(caption = "Self-Employed Extracted Coefficients for Unemployment") %>% 
  kable_styling(latex_options = "scale_down")

```

## Wage and Salary

```{r}
#| message: false
data.frame(pctile = c(.1, .25, .5, .75, .9), 
           base_model = coef(unemp_earnings_ws)["unempf12_6_fct1",],
           model2 = coef(unemp_earnings2_ws)["unempf12_6_fct1",],
           model3 = coef(unemp_earnings3_ws)["unempf12_6_fct1",]) %>% 
  knitr::kable(caption = "Wage and Salary Extracted Coefficients for Unemployment") %>% 
  kable_styling(latex_options = "scale_down")
```

# Table 8 Relationship between Initial Employment Status and Log Annual Earnings (quantile regression)

## Full Sample

Below variables are named as follows:

-   base_SE shows the coefficients for the base model (earnings predicted only by initial status) for those who started as SE versus those who started as Wage and salaried.

-   base_unemp shows the coefficients for the base model showing the difference for those who started as unemployed vs those who started as wage and salary

```{r}
#| message: false

data.frame(pctile = c(.1, .25, .5, .75, .9), 
           base_SE = coef(status_earnings)["mode_status_f12v2_fctSE",],
           base_unemp = coef(status_earnings)["mode_status_f12v2_fctUnemp",],
           model2_SE = coef(status_earnings2)["mode_status_f12v2_fctSE",],
           model2_unemp = coef(status_earnings2)["mode_status_f12v2_fctUnemp",],
           model3_SE = coef(status_earnings3)["mode_status_f12v2_fctSE",],
           model3_unemp = coef(status_earnings3)["mode_status_f12v2_fctUnemp",]) %>% 
  knitr::kable(caption = "Full Sample Extracted Coefficients for Initial Status") %>% 
  kable_styling(latex_options = "scale_down")
```

## Self-employed Sample

Again this throws some convergence warnings that will need to be looked into further and test different optimizers.

```{r}
data.frame(pctile = c(.1, .25, .5, .75, .9), 
           base_SE = coef(status_earnings_se)["mode_status_f12v2_fctSE",],
           base_unemp = coef(status_earnings_se)["mode_status_f12v2_fctUnemp",],
           model2_SE = coef(status_earnings2_se)["mode_status_f12v2_fctSE",],
           model2_unemp = coef(status_earnings2_se)["mode_status_f12v2_fctUnemp",],
           model3_SE = coef(status_earnings3_se)["mode_status_f12v2_fctSE",],
           model3_unemp = coef(status_earnings3_se)["mode_status_f12v2_fctUnemp",]) %>% 
  knitr::kable(caption = "Self-Employed Sample Extracted Coefficients for Initial Status") %>% 
  kable_styling(latex_options = "scale_down")
```

## Wage and Salary Sample

```{r}
#| message: false

data.frame(pctile = c(.1, .25, .5, .75, .9), 
           base_SE = coef(status_earnings_ws)["mode_status_f12v2_fctSE",],
           base_unemp = coef(status_earnings_ws)["mode_status_f12v2_fctUnemp",],
           model2_SE = coef(status_earnings2_ws)["mode_status_f12v2_fctSE",],
           model2_unemp = coef(status_earnings2_ws)["mode_status_f12v2_fctUnemp",],
           model3_SE = coef(status_earnings3_ws)["mode_status_f12v2_fctSE",],
           model3_unemp = coef(status_earnings3_ws)["mode_status_f12v2_fctUnemp",]) %>% 
  knitr::kable(caption = "Wage Sample Extracted Coefficients for Initial Status") %>% 
  kable_styling(latex_options = "scale_down")
```

## Table 11 Business Value and Unemployment (quantile Regression)

## Table 27 Business value and Initial Employment Status (quantile regression)

# Appendix: 
## Full Summary Tables
### Full Sample Unemployment
```{r}
summary(unemp_earnings3)
```

### SE Sample Unemployment
```{r}
summary(unemp_earnings3_se)
```

### WS Sample Unemployment
```{r}
summary(unemp_earnings3_ws)
```



### Full Sample Initial Status

```{r}
summary(status_earnings3)
```


### SE Sample Initial Status
```{r}
summary(status_earnings3_se)
```

### WS Sample Initial Status
```{r}
summary(status_earnings_ws)
```


##  Code

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
